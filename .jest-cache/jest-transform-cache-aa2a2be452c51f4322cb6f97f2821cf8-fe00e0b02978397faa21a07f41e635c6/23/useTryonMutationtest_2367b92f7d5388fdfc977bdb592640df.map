{"version":3,"sources":["/Users/willstreeter/WebstormProjects/vibe-coding/those-people/The-Sus-Fit-gp/__tests__/business-layer/mutations/useTryonMutation.test.ts"],"sourcesContent":["// Comprehensive Tests for useTryonMutation Hook\n// Tests covering all scenarios: success, error, retry, image processing, optimistic updates\n\nimport { renderHook, act, waitFor } from '@testing-library/react';\nimport { QueryClient } from '@tanstack/react-query';\nimport { useTryonMutation } from '../../../src/business-layer/mutations/useTryonMutation';\nimport type {\n  TryonMutationVariables,\n  TryonMutationResponse,\n  TryonMutationError,\n  UseTryonMutationConfig\n} from '../../../src/business-layer/types/tryon.types';\nimport {\n  createTestQueryClient,\n  createQueryClientWrapper,\n  mockTryonAPI,\n  mockTryonVariables,\n  mockTryonResponse,\n  mockTryonError,\n  mockConsole,\n  waitForPromises\n} from '../../../src/business-layer/tests/testUtils';\n\n// Create persistent mock functions for optimistic updates\nconst mockStartOptimisticUpdate = jest.fn(() => ({\n  optimisticId: 'mock-optimistic-id',\n  variables: {}, // Will be populated from test data\n  config: {},\n  startTime: Date.now(),\n  rollbackFunctions: []\n}));\nconst mockCompleteOptimisticUpdate = jest.fn();\nconst mockRollbackOptimisticUpdate = jest.fn();\n\n// Mock the optimistic updates manager\njest.mock('../../../src/business-layer/utils/optimisticUpdates', () => ({\n  getOptimisticUpdatesManager: () => ({\n    startOptimisticUpdate: mockStartOptimisticUpdate,\n    completeOptimisticUpdate: mockCompleteOptimisticUpdate,\n    rollbackOptimisticUpdate: mockRollbackOptimisticUpdate\n  }),\n  OptimisticUpdatesManager: jest.fn(() => ({\n    startOptimisticUpdate: mockStartOptimisticUpdate,\n    completeOptimisticUpdate: mockCompleteOptimisticUpdate,\n    rollbackOptimisticUpdate: mockRollbackOptimisticUpdate\n  }))\n}));\n\n// Mock the cache invalidation utility\njest.mock('../../../src/business-layer/utils/cacheInvalidation', () => ({\n  invalidateCacheAfterMutation: jest.fn().mockResolvedValue(undefined),\n  getCacheInvalidationManager: jest.fn(() => ({\n    invalidateAfterSuccess: jest.fn(),\n    invalidateAfterError: jest.fn()\n  }))\n}));\n\n// Mock image processing utilities\njest.mock('../../../src/business-layer/utils/imageProcessing', () => ({\n  processImageForTryon: jest.fn().mockResolvedValue({\n    originalSize: 2048576,\n    processedSize: 1048576,\n    compressionRatio: 0.5,\n    processingTime: 123,\n    processedImage: 'data:image/jpeg;base64,processed-image',\n    metadata: {\n      originalDimensions: { width: 1920, height: 1080 },\n      processedDimensions: { width: 1024, height: 1536 },\n      format: 'jpeg',\n      quality: 0.9\n    }\n  })\n}));\n\n// Mock error handling utilities\njest.mock('../../../src/business-layer/utils/errorHandling', () => ({\n  classifyTryonError: jest.fn((error) => ({\n    userMessage: 'An error occurred',\n    technicalMessage: error.message || 'Unknown error',\n    errorCode: 'UNKNOWN_ERROR',\n    retryable: false,\n    category: 'NETWORK_ERROR',\n    severity: 'MEDIUM',\n    recoveryActions: []\n  })),\n  logAndClassifyError: jest.fn((error) => ({\n    userMessage: 'An error occurred',\n    technicalMessage: error.details || error.message || 'Unknown error',\n    errorCode: 'UNKNOWN_ERROR',\n    retryable: false,\n    category: 'NETWORK_ERROR',\n    severity: 'MEDIUM',\n    recoveryActions: []\n  })),\n  isErrorRetryable: jest.fn(() => true)\n}));\n\ndescribe('useTryonMutation Hook', () => {\n  let queryClient: QueryClient;\n  let consoleRef: ReturnType<typeof mockConsole>;\n\n  beforeEach(() => {\n    queryClient = createTestQueryClient();\n    // Temporarily disable console mocking to see debug logs\n    // consoleRef = mockConsole();\n    jest.clearAllMocks();\n    // Clear the specific optimistic update mocks\n    mockStartOptimisticUpdate.mockClear();\n    mockCompleteOptimisticUpdate.mockClear();\n    mockRollbackOptimisticUpdate.mockClear();\n    global.fetch = jest.fn();\n  });\n\n  afterEach(() => {\n    queryClient.clear();\n    // consoleRef.restore();\n    jest.restoreAllMocks();\n  });\n\n  describe('Basic Functionality', () => {\n    it('should initialize with correct default state', () => {\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      expect(result.current.data).toBeUndefined();\n      expect(result.current.error).toBeNull();\n      expect(result.current.isLoading).toBe(false);\n      expect(result.current.isSuccess).toBe(false);\n      expect(result.current.isError).toBe(false);\n      expect(result.current.isIdle).toBe(true);\n      expect(result.current.status).toBe('idle');\n      expect(typeof result.current.mutate).toBe('function');\n      expect(typeof result.current.mutateAsync).toBe('function');\n      expect(typeof result.current.reset).toBe('function');\n    });\n\n    it('should accept custom configuration', () => {\n      const config: UseTryonMutationConfig = {\n        enableRetry: false,\n        maxRetries: 5,\n        initialRetryDelay: 2000,\n        enableOptimisticUpdates: true\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      expect(result.current.isIdle).toBe(true);\n    });\n  });\n\n  describe('Success Scenarios', () => {\n    it('should handle successful mutation with base64 strings', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(result.current.data).toEqual(mockTryonResponse);\n      expect(result.current.error).toBeNull();\n      expect(result.current.isLoading).toBe(false);\n      expect(global.fetch).toHaveBeenCalledWith(\n        '/api/tryon',\n        expect.objectContaining({\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: expect.stringContaining('\"modelImage\":\"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/mock-model-image\"')\n        })\n      );\n    });\n\n    it('should handle successful mutation with File objects', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const mockFile = new File(['mock content'], 'test.jpg', { type: 'image/jpeg' });\n      const variablesWithFiles = {\n        modelImage: mockFile,\n        apparelImages: [mockFile],\n        options: mockTryonVariables.options\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(variablesWithFiles as any);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(result.current.data).toEqual(mockTryonResponse);\n    });\n\n    it('should call success callback on successful mutation', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const onSuccess = jest.fn();\n      const config: UseTryonMutationConfig = { onSuccess };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(onSuccess).toHaveBeenCalledWith(\n        mockTryonResponse,\n        expect.objectContaining(mockTryonVariables),\n        expect.objectContaining({\n          variables: expect.objectContaining(mockTryonVariables),\n          startTime: expect.any(Number),\n          retryCount: 0\n        })\n      );\n    });\n\n    it('should handle mutation with timeout configuration', async () => {\n      mockTryonAPI(mockTryonResponse, undefined, 100); // 100ms delay\n\n      const variablesWithTimeout = {\n        ...mockTryonVariables,\n        options: {\n          ...mockTryonVariables.options,\n          timeout: 5000\n        }\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(variablesWithTimeout);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(result.current.data).toEqual(mockTryonResponse);\n    });\n  });\n\n  describe('Error Scenarios', () => {\n    it('should handle API error responses', async () => {\n      const apiError = {\n        ...mockTryonError,\n        status: 400\n      };\n      mockTryonAPI(undefined, apiError);\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(result.current.error).toBeTruthy();\n      expect(result.current.data).toBeUndefined();\n      expect(result.current.isLoading).toBe(false);\n    });\n\n    it('should call error callback on failed mutation', async () => {\n      const apiError = {\n        ...mockTryonError,\n        error: 'An error occurred',\n        details: 'API request failed'\n      };\n      mockTryonAPI(undefined, apiError);\n\n      const onError = jest.fn();\n      const config: UseTryonMutationConfig = { onError };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(onError).toHaveBeenCalledWith(\n        expect.objectContaining({\n          error: 'An error occurred',\n          details: 'API request failed'\n        }),\n        expect.objectContaining(mockTryonVariables),\n        expect.objectContaining({\n          variables: expect.objectContaining(mockTryonVariables)\n        })\n      );\n    });\n\n    it('should handle network timeout errors', async () => {\n      // Mock fetch to simulate timeout\n      (global.fetch as jest.Mock).mockImplementation(() => {\n        return new Promise((_, reject) => {\n          setTimeout(() => {\n            const error = new Error('Request timeout');\n            error.name = 'AbortError';\n            reject(error);\n          }, 50);\n        });\n      });\n\n      const variablesWithShortTimeout = {\n        ...mockTryonVariables,\n        options: {\n          ...mockTryonVariables.options,\n          timeout: 10 // Very short timeout\n        }\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(variablesWithShortTimeout);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      }, { timeout: 1000 });\n\n      expect(result.current.error).toBeTruthy();\n    });\n\n    it('should handle image processing errors', async () => {\n      const { processImageForTryon } = require('../../../src/business-layer/utils/imageProcessing');\n      processImageForTryon.mockRejectedValueOnce(new Error('Invalid image format'));\n\n      const mockFile = new File(['invalid content'], 'test.txt', { type: 'text/plain' });\n      const variablesWithInvalidFile = {\n        modelImage: mockFile,\n        apparelImages: [mockFile],\n        options: mockTryonVariables.options\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(variablesWithInvalidFile as any);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(result.current.error).toBeTruthy();\n    });\n  });\n\n  describe('Retry Logic', () => {\n    it('should retry on retryable errors', async () => {\n      let callCount = 0;\n      (global.fetch as jest.Mock).mockImplementation(() => {\n        callCount++;\n        if (callCount <= 2) {\n          return Promise.resolve({\n            ok: false,\n            status: 500,\n            json: () => Promise.resolve({ error: 'Internal Server Error' })\n          });\n        }\n        return Promise.resolve({\n          ok: true,\n          status: 200,\n          json: () => Promise.resolve(mockTryonResponse)\n        });\n      });\n\n      const config: UseTryonMutationConfig = {\n        enableRetry: true,\n        maxRetries: 3,\n        initialRetryDelay: 10 // Short delay for testing\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      }, { timeout: 5000 });\n\n      expect(callCount).toBe(3);\n      expect(result.current.data).toEqual(mockTryonResponse);\n    });\n\n    it('should not retry when retry is disabled', async () => {\n      let callCount = 0;\n      (global.fetch as jest.Mock).mockImplementation(() => {\n        callCount++;\n        return Promise.resolve({\n          ok: false,\n          status: 500,\n          json: () => Promise.resolve({ error: 'Internal Server Error' })\n        });\n      });\n\n      const config: UseTryonMutationConfig = {\n        enableRetry: false\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(callCount).toBe(1);\n    });\n\n    it('should stop retrying after max retries reached', async () => {\n      let callCount = 0;\n      (global.fetch as jest.Mock).mockImplementation(() => {\n        callCount++;\n        return Promise.resolve({\n          ok: false,\n          status: 500,\n          json: () => Promise.resolve({ error: 'Internal Server Error' })\n        });\n      });\n\n      const config: UseTryonMutationConfig = {\n        enableRetry: true,\n        maxRetries: 2,\n        initialRetryDelay: 10\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      }, { timeout: 5000 });\n\n      expect(callCount).toBe(3); // Initial call + 2 retries\n    });\n  });\n\n  describe('Optimistic Updates Integration', () => {\n    it('should start optimistic updates when enabled', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const config: UseTryonMutationConfig = {\n        enableOptimisticUpdates: true,\n        optimisticConfig: {\n          showPreview: true,\n          updateHistory: true\n        }\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(mockStartOptimisticUpdate).toHaveBeenCalledWith(\n        expect.objectContaining(mockTryonVariables),\n        expect.objectContaining({\n          showPreview: true,\n          updateHistory: true\n        })\n      );\n      expect(mockCompleteOptimisticUpdate).toHaveBeenCalledWith(\n        'mock-optimistic-id',\n        mockTryonResponse,\n        expect.any(Object)\n      );\n    });\n\n    it('should rollback optimistic updates on error', async () => {\n      const config: UseTryonMutationConfig = {\n        enableOptimisticUpdates: true\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      // Set up mock AFTER the hook is rendered to avoid beforeEach reset\n      const apiError = new Error('API request failed');\n      mockTryonAPI(undefined, apiError);\n\n      console.log('🟠 TEST: About to call mutate', result.current);\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n        // Wait for mutation to complete\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n      console.log('🟠 TEST: After mutate call', result.current);\n\n      await waitFor(() => {\n        console.log('🟠 TEST: Checking mutation state', { \n          isError: result.current.isError, \n          status: result.current.status,\n          error: result.current.error \n        });\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(mockRollbackOptimisticUpdate).toHaveBeenCalledWith(\n        'mock-optimistic-id',\n        expect.any(Error)\n      );\n    });\n  });\n\n  describe('Cache Invalidation Integration', () => {\n    it('should invalidate cache on successful mutation', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const { invalidateCacheAfterMutation } = require('../../../src/business-layer/utils/cacheInvalidation');\n\n      const config: UseTryonMutationConfig = {\n        cacheInvalidationConfig: {\n          invalidateHistory: true,\n          invalidateUserData: true\n        }\n      };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(invalidateCacheAfterMutation).toHaveBeenCalledWith(\n        queryClient,\n        mockTryonResponse,\n        expect.objectContaining(mockTryonVariables),\n        expect.any(Object),\n        expect.objectContaining({\n          invalidateHistory: true,\n          invalidateUserData: true\n        })\n      );\n    });\n\n    it('should handle cache invalidation failures gracefully', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const { invalidateCacheAfterMutation } = require('../../../src/business-layer/utils/cacheInvalidation');\n      invalidateCacheAfterMutation.mockRejectedValueOnce(new Error('Cache invalidation failed'));\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      // Should still succeed even if cache invalidation fails\n      expect(result.current.data).toEqual(mockTryonResponse);\n      expect(consoleRef.mocks.warn).toHaveBeenCalledWith(\n        'Failed to invalidate cache after mutation:',\n        expect.any(Error)\n      );\n    });\n  });\n\n  describe('Lifecycle Callbacks', () => {\n    it('should call onMutate callback before mutation', async () => {\n      mockTryonAPI(mockTryonResponse, undefined, 100);\n\n      const onMutate = jest.fn().mockResolvedValue({ customData: 'test' });\n      const config: UseTryonMutationConfig = { onMutate };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      expect(onMutate).toHaveBeenCalledWith(\n        expect.objectContaining(mockTryonVariables)\n      );\n    });\n\n    it('should call onSettled callback after mutation completes', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const onSettled = jest.fn();\n      const config: UseTryonMutationConfig = { onSettled };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(onSettled).toHaveBeenCalledWith(\n        mockTryonResponse,\n        null,\n        expect.objectContaining(mockTryonVariables),\n        expect.objectContaining({\n          variables: expect.objectContaining(mockTryonVariables)\n        })\n      );\n    });\n\n    it('should call onSettled callback after mutation fails', async () => {\n      const apiError = new Error('API request failed');\n      mockTryonAPI(undefined, apiError);\n\n      const onSettled = jest.fn();\n      const config: UseTryonMutationConfig = { onSettled };\n\n      const { result } = renderHook(\n        () => useTryonMutation(config),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(onSettled).toHaveBeenCalledWith(\n        undefined,\n        expect.objectContaining({\n          error: 'An error occurred'\n        }),\n        expect.objectContaining(mockTryonVariables),\n        expect.objectContaining({\n          variables: expect.objectContaining(mockTryonVariables)\n        })\n      );\n    });\n  });\n\n  describe('Reset Functionality', () => {\n    it('should reset mutation state correctly', async () => {\n      mockTryonAPI(mockTryonResponse);\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      // Execute mutation\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isSuccess).toBe(true);\n      });\n\n      expect(result.current.data).toEqual(mockTryonResponse);\n\n      // Reset mutation\n      act(() => {\n        result.current.reset();\n      });\n\n      expect(result.current.data).toBeUndefined();\n      expect(result.current.error).toBeNull();\n      expect(result.current.isLoading).toBe(false);\n      expect(result.current.isSuccess).toBe(false);\n      expect(result.current.isError).toBe(false);\n      expect(result.current.isIdle).toBe(true);\n      expect(result.current.status).toBe('idle');\n    });\n  });\n\n  describe('Edge Cases', () => {\n    it('should handle malformed API responses', async () => {\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        status: 200,\n        json: () => Promise.resolve({ invalid: 'response' }) // Missing img_generated field\n      });\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(result.current.error).toBeTruthy();\n    });\n\n    it('should handle JSON parsing errors', async () => {\n      (global.fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        status: 200,\n        json: () => Promise.reject(new Error('Invalid JSON'))\n      });\n\n      const { result } = renderHook(\n        () => useTryonMutation(),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      await waitFor(() => {\n        expect(result.current.isError).toBe(true);\n      });\n\n      expect(result.current.error).toBeTruthy();\n    });\n\n    it('should handle component unmount during mutation', async () => {\n      mockTryonAPI(mockTryonResponse, undefined, 500); // Long delay\n\n      const { result, unmount } = renderHook(\n        () => useTryonMutation({ enableOptimisticUpdates: true }),\n        {\n          wrapper: createQueryClientWrapper(queryClient)\n        }\n      );\n\n      // Start mutation\n      await act(async () => {\n        result.current.mutate(mockTryonVariables);\n      });\n\n      // Unmount component before mutation completes\n      unmount();\n\n      // Wait for cleanup\n      await waitForPromises();\n\n      // Should rollback optimistic updates on unmount\n      expect(mockRollbackOptimisticUpdate).toHaveBeenCalledWith(\n        'mock-optimistic-id',\n        expect.objectContaining({ message: 'Component unmounted' })\n      );\n    });\n  });\n});"],"names":["jest","mock","getOptimisticUpdatesManager","startOptimisticUpdate","mockStartOptimisticUpdate","completeOptimisticUpdate","mockCompleteOptimisticUpdate","rollbackOptimisticUpdate","mockRollbackOptimisticUpdate","OptimisticUpdatesManager","fn","invalidateCacheAfterMutation","mockResolvedValue","undefined","getCacheInvalidationManager","invalidateAfterSuccess","invalidateAfterError","processImageForTryon","originalSize","processedSize","compressionRatio","processingTime","processedImage","metadata","originalDimensions","width","height","processedDimensions","format","quality","classifyTryonError","error","userMessage","technicalMessage","message","errorCode","retryable","category","severity","recoveryActions","logAndClassifyError","details","isErrorRetryable","optimisticId","variables","config","startTime","Date","now","rollbackFunctions","describe","queryClient","consoleRef","beforeEach","createTestQueryClient","clearAllMocks","mockClear","global","fetch","afterEach","clear","restoreAllMocks","it","result","renderHook","useTryonMutation","wrapper","createQueryClientWrapper","expect","current","data","toBeUndefined","toBeNull","isLoading","toBe","isSuccess","isError","isIdle","status","mutate","mutateAsync","reset","enableRetry","maxRetries","initialRetryDelay","enableOptimisticUpdates","mockTryonAPI","mockTryonResponse","act","mockTryonVariables","waitFor","toEqual","toHaveBeenCalledWith","objectContaining","method","headers","body","stringContaining","mockFile","File","type","variablesWithFiles","modelImage","apparelImages","options","onSuccess","any","Number","retryCount","variablesWithTimeout","timeout","apiError","mockTryonError","toBeTruthy","onError","mockImplementation","Promise","_","reject","setTimeout","Error","name","variablesWithShortTimeout","require","mockRejectedValueOnce","variablesWithInvalidFile","callCount","resolve","ok","json","optimisticConfig","showPreview","updateHistory","Object","console","log","cacheInvalidationConfig","invalidateHistory","invalidateUserData","mocks","warn","onMutate","customData","onSettled","mockResolvedValueOnce","invalid","unmount","waitForPromises"],"mappings":"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"}