bffaf49c23e5a81f7304d4a36eadf55f
// Try-On History Storage Service
// Implements persistent storage for try-on history using localStorage with compression
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    LocalStorageTryonHistoryService: function() {
        return LocalStorageTryonHistoryService;
    },
    defaultHistoryService: function() {
        return defaultHistoryService;
    }
});
const _imageProcessing = require("../utils/imageProcessing");
/**
 * Default configuration for history storage
 */ const DEFAULT_CONFIG = {
    storageType: 'localStorage',
    maxEntries: 50,
    maxEntrySizeKB: 2048,
    compressImages: true,
    compressionQuality: 0.8,
    autoCleanup: true,
    encryptionKey: ''
};
/**
 * Storage keys for localStorage
 */ const STORAGE_KEYS = {
    ENTRIES: 'susfit_tryon_history_entries',
    CONFIG: 'susfit_tryon_history_config',
    METADATA: 'susfit_tryon_history_metadata'
};
/**
 * Generate a unique ID for history entries
 */ function generateHistoryId() {
    return `tryon_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}
/**
 * Calculate the size of a history entry in KB
 */ function calculateEntrySize(entry) {
    const json = JSON.stringify(entry);
    return new Blob([
        json
    ]).size / 1024;
}
/**
 * Compress images in a history entry
 */ async function compressHistoryEntry(entry, config) {
    if (!config.compressImages) {
        return entry;
    }
    try {
        const maxSizeKB = config.maxEntrySizeKB / (2 + entry.apparelImages.length);
        const quality = config.compressionQuality;
        // Compress generated image
        const compressedGenerated = await (0, _imageProcessing.compressBase64)(entry.generatedImage, maxSizeKB, quality);
        // Compress model image
        const compressedModel = await (0, _imageProcessing.compressBase64)(entry.modelImage, maxSizeKB, quality);
        // Compress apparel images
        const compressedApparel = await Promise.all(entry.apparelImages.map((img)=>(0, _imageProcessing.compressBase64)(img, maxSizeKB, quality)));
        return {
            ...entry,
            generatedImage: compressedGenerated,
            modelImage: compressedModel,
            apparelImages: compressedApparel,
            metadata: {
                ...entry.metadata,
                imageProcessingResults: {
                    ...entry.metadata?.imageProcessingResults,
                    finalImageSizes: {
                        modelImageSize: (0, _imageProcessing.getBase64Size)(compressedModel),
                        apparelImageSizes: compressedApparel.map((img)=>(0, _imageProcessing.getBase64Size)(img))
                    }
                }
            }
        };
    } catch (error) {
        if (error instanceof _imageProcessing.CompressionFailedError) {
            console.warn('Failed to compress history entry images, using original', error);
            return entry;
        }
        throw error;
    }
}
class LocalStorageTryonHistoryService {
    constructor(config = {}){
        this.isInitialized = false;
        this.config = {
            ...DEFAULT_CONFIG,
            ...config
        };
    // Don't initialize immediately - defer until first use
    }
    /**
   * Initialize localStorage storage (called lazily on first use)
   */ initializeStorage() {
        if (this.isInitialized) {
            return;
        }
        try {
            // Check if localStorage is available (client-side only)
            if (typeof window === 'undefined' || !window.localStorage) {
                throw new Error('localStorage is not available');
            }
            // Initialize config if not exists
            if (!localStorage.getItem(STORAGE_KEYS.CONFIG)) {
                localStorage.setItem(STORAGE_KEYS.CONFIG, JSON.stringify(this.config));
            }
            // Initialize entries array if not exists
            if (!localStorage.getItem(STORAGE_KEYS.ENTRIES)) {
                localStorage.setItem(STORAGE_KEYS.ENTRIES, JSON.stringify([]));
            }
            // Initialize metadata if not exists
            if (!localStorage.getItem(STORAGE_KEYS.METADATA)) {
                const metadata = {
                    version: '1.0.0',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.METADATA, JSON.stringify(metadata));
            }
            this.isInitialized = true;
        } catch (error) {
            console.error('Failed to initialize history storage:', error);
            throw new Error('History storage initialization failed');
        }
    }
    /**
   * Ensure storage is initialized before use
   */ ensureInitialized() {
        if (!this.isInitialized) {
            this.initializeStorage();
        }
    }
    /**
   * Get all stored entries from localStorage
   */ getStoredEntries() {
        this.ensureInitialized();
        try {
            const entriesJson = localStorage.getItem(STORAGE_KEYS.ENTRIES);
            return entriesJson ? JSON.parse(entriesJson) : [];
        } catch (error) {
            console.error('Failed to parse stored entries:', error);
            return [];
        }
    }
    /**
   * Save entries to localStorage
   */ saveEntries(entries) {
        this.ensureInitialized();
        try {
            localStorage.setItem(STORAGE_KEYS.ENTRIES, JSON.stringify(entries));
            // Update metadata
            const metadata = JSON.parse(localStorage.getItem(STORAGE_KEYS.METADATA) || '{}');
            metadata.lastUpdated = new Date().toISOString();
            localStorage.setItem(STORAGE_KEYS.METADATA, JSON.stringify(metadata));
        } catch (error) {
            console.error('Failed to save entries to localStorage:', error);
            throw new Error('Failed to save history entries');
        }
    }
    /**
   * Perform cleanup if needed
   */ performCleanupIfNeeded(entries) {
        if (!this.config.autoCleanup || entries.length <= this.config.maxEntries) {
            return entries;
        }
        // Sort by timestamp and keep only the most recent entries
        const sorted = [
            ...entries
        ].sort((a, b)=>new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
        return sorted.slice(0, this.config.maxEntries);
    }
    /**
   * Filter and sort entries based on query options
   */ filterAndSortEntries(entries, options = {}) {
        let filtered = [
            ...entries
        ];
        // Apply favorites filter
        if (options.favoritesOnly) {
            filtered = filtered.filter((entry)=>entry.isFavorite);
        }
        // Apply date range filter
        if (options.dateRange) {
            const startDate = new Date(options.dateRange.startDate);
            const endDate = new Date(options.dateRange.endDate);
            filtered = filtered.filter((entry)=>{
                const entryDate = new Date(entry.timestamp);
                return entryDate >= startDate && entryDate <= endDate;
            });
        }
        // Apply search term filter
        if (options.searchTerm) {
            const searchTerm = options.searchTerm.toLowerCase();
            filtered = filtered.filter((entry)=>entry.tags?.some((tag)=>tag.toLowerCase().includes(searchTerm)) || entry.notes?.toLowerCase().includes(searchTerm));
        }
        // Apply sorting
        const sortBy = options.sortBy || 'timestamp';
        const sortDirection = options.sortDirection || 'desc';
        filtered.sort((a, b)=>{
            let aValue, bValue;
            switch(sortBy){
                case 'timestamp':
                    aValue = new Date(a.timestamp);
                    bValue = new Date(b.timestamp);
                    break;
                case 'processingTime':
                    aValue = a.processingTime || 0;
                    bValue = b.processingTime || 0;
                    break;
                case 'isFavorite':
                    aValue = a.isFavorite ? 1 : 0;
                    bValue = b.isFavorite ? 1 : 0;
                    break;
                default:
                    aValue = a.timestamp;
                    bValue = b.timestamp;
            }
            if (sortDirection === 'asc') {
                return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
            } else {
                return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
            }
        });
        return filtered;
    }
    /**
   * Add a new history entry
   */ async addEntry(options) {
        const entry = {
            id: generateHistoryId(),
            timestamp: new Date().toISOString(),
            generatedImage: options.generatedImage,
            modelImage: options.modelImage,
            apparelImages: options.apparelImages,
            processingTime: options.processingTime,
            metadata: options.metadata,
            tags: options.tags || [],
            isFavorite: options.isFavorite || false,
            notes: options.notes || ''
        };
        // Compress entry if enabled
        const compressedEntry = await compressHistoryEntry(entry, this.config);
        // Check entry size
        const entrySize = calculateEntrySize(compressedEntry);
        if (entrySize > this.config.maxEntrySizeKB) {
            throw new Error(`History entry too large: ${entrySize.toFixed(2)}KB exceeds limit of ${this.config.maxEntrySizeKB}KB`);
        }
        // Get current entries and add the new one
        let entries = this.getStoredEntries();
        entries.push(compressedEntry);
        // Perform cleanup if needed
        entries = this.performCleanupIfNeeded(entries);
        // Save updated entries
        this.saveEntries(entries);
        return compressedEntry;
    }
    /**
   * Get history entries with filtering and pagination
   */ async getEntries(options = {}) {
        const allEntries = this.getStoredEntries();
        const filteredEntries = this.filterAndSortEntries(allEntries, options);
        // Apply pagination
        const page = options.page || 0;
        const pageSize = options.pageSize || 20;
        const startIndex = page * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedEntries = filteredEntries.slice(startIndex, endIndex);
        return {
            entries: paginatedEntries,
            totalCount: filteredEntries.length,
            currentPage: page,
            pageSize,
            hasMore: endIndex < filteredEntries.length,
            lastUpdated: new Date().toISOString()
        };
    }
    /**
   * Get a specific history entry by ID
   */ async getEntry(id) {
        const entries = this.getStoredEntries();
        return entries.find((entry)=>entry.id === id) || null;
    }
    /**
   * Update an existing history entry
   */ async updateEntry(id, updates) {
        const entries = this.getStoredEntries();
        const entryIndex = entries.findIndex((entry)=>entry.id === id);
        if (entryIndex === -1) {
            throw new Error(`History entry with ID ${id} not found`);
        }
        // Apply updates
        const updatedEntry = {
            ...entries[entryIndex],
            ...updates,
            // Preserve ID and timestamp, update only if explicitly provided
            id: entries[entryIndex].id,
            timestamp: updates.timestamp || entries[entryIndex].timestamp
        };
        entries[entryIndex] = updatedEntry;
        this.saveEntries(entries);
        return updatedEntry;
    }
    /**
   * Delete a history entry
   */ async deleteEntry(id) {
        const entries = this.getStoredEntries();
        const filteredEntries = entries.filter((entry)=>entry.id !== id);
        if (filteredEntries.length === entries.length) {
            return false; // Entry not found
        }
        this.saveEntries(filteredEntries);
        return true;
    }
    /**
   * Clear all history entries
   */ async clearAll() {
        this.ensureInitialized();
        try {
            localStorage.setItem(STORAGE_KEYS.ENTRIES, JSON.stringify([]));
            return true;
        } catch (error) {
            console.error('Failed to clear history:', error);
            return false;
        }
    }
    /**
   * Get storage statistics
   */ async getStorageStats() {
        const entries = this.getStoredEntries();
        let totalSizeKB = 0;
        entries.forEach((entry)=>{
            totalSizeKB += calculateEntrySize(entry);
        });
        const timestamps = entries.map((entry)=>entry.timestamp).sort();
        return {
            totalEntries: entries.length,
            totalSizeKB,
            oldestEntry: timestamps[0],
            newestEntry: timestamps[timestamps.length - 1]
        };
    }
    /**
   * Export history data
   */ async exportHistory() {
        return this.getStoredEntries();
    }
    /**
   * Import history data
   */ async importHistory(entries) {
        try {
            // Validate entries
            const validEntries = entries.filter((entry)=>entry.id && entry.generatedImage && entry.modelImage && entry.apparelImages);
            // Get existing entries and merge with imports
            const existingEntries = this.getStoredEntries();
            const existingIds = new Set(existingEntries.map((entry)=>entry.id));
            // Only import entries that don't already exist
            const newEntries = validEntries.filter((entry)=>!existingIds.has(entry.id));
            if (newEntries.length === 0) {
                return 0;
            }
            // Merge and save
            const mergedEntries = [
                ...existingEntries,
                ...newEntries
            ];
            const cleanedEntries = this.performCleanupIfNeeded(mergedEntries);
            this.saveEntries(cleanedEntries);
            return newEntries.length;
        } catch (error) {
            console.error('Failed to import history:', error);
            throw new Error('History import failed');
        }
    }
    /**
   * Update service configuration
   */ updateConfig(newConfig) {
        this.config = {
            ...this.config,
            ...newConfig
        };
        this.ensureInitialized();
        try {
            localStorage.setItem(STORAGE_KEYS.CONFIG, JSON.stringify(this.config));
        } catch (error) {
            console.error('Failed to save config:', error);
        }
    }
    /**
   * Get current configuration
   */ getConfig() {
        return {
            ...this.config
        };
    }
}
const defaultHistoryService = new LocalStorageTryonHistoryService();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy93aWxsc3RyZWV0ZXIvV2Vic3Rvcm1Qcm9qZWN0cy92aWJlLWNvZGluZy90aG9zZS1wZW9wbGUvVGhlLVN1cy1GaXQtZ3Avc3JjL2J1c2luZXNzLWxheWVyL3NlcnZpY2VzL3RyeW9uSGlzdG9yeVNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gVHJ5LU9uIEhpc3RvcnkgU3RvcmFnZSBTZXJ2aWNlXG4vLyBJbXBsZW1lbnRzIHBlcnNpc3RlbnQgc3RvcmFnZSBmb3IgdHJ5LW9uIGhpc3RvcnkgdXNpbmcgbG9jYWxTdG9yYWdlIHdpdGggY29tcHJlc3Npb25cblxuaW1wb3J0IHsgXG4gIGNvbXByZXNzQmFzZTY0LCBcbiAgZ2V0QmFzZTY0U2l6ZSwgXG4gIENvbXByZXNzaW9uRmFpbGVkRXJyb3IgXG59IGZyb20gJy4uL3V0aWxzL2ltYWdlUHJvY2Vzc2luZyc7XG5pbXBvcnQgdHlwZSB7XG4gIFRyeW9uSGlzdG9yeUVudHJ5LFxuICBUcnlvbkhpc3RvcnlDb2xsZWN0aW9uLFxuICBUcnlvbkhpc3RvcnlRdWVyeU9wdGlvbnMsXG4gIENyZWF0ZVRyeW9uSGlzdG9yeUVudHJ5T3B0aW9ucyxcbiAgVHJ5b25IaXN0b3J5U2VydmljZSxcbiAgVHJ5b25IaXN0b3J5U3RvcmFnZUNvbmZpZ1xufSBmcm9tICcuLi90eXBlcy9oaXN0b3J5LnR5cGVzJztcblxuLyoqXG4gKiBEZWZhdWx0IGNvbmZpZ3VyYXRpb24gZm9yIGhpc3Rvcnkgc3RvcmFnZVxuICovXG5jb25zdCBERUZBVUxUX0NPTkZJRzogUmVxdWlyZWQ8VHJ5b25IaXN0b3J5U3RvcmFnZUNvbmZpZz4gPSB7XG4gIHN0b3JhZ2VUeXBlOiAnbG9jYWxTdG9yYWdlJyxcbiAgbWF4RW50cmllczogNTAsXG4gIG1heEVudHJ5U2l6ZUtCOiAyMDQ4LCAvLyAyTUIgcGVyIGVudHJ5XG4gIGNvbXByZXNzSW1hZ2VzOiB0cnVlLFxuICBjb21wcmVzc2lvblF1YWxpdHk6IDAuOCxcbiAgYXV0b0NsZWFudXA6IHRydWUsXG4gIGVuY3J5cHRpb25LZXk6ICcnXG59O1xuXG4vKipcbiAqIFN0b3JhZ2Uga2V5cyBmb3IgbG9jYWxTdG9yYWdlXG4gKi9cbmNvbnN0IFNUT1JBR0VfS0VZUyA9IHtcbiAgRU5UUklFUzogJ3N1c2ZpdF90cnlvbl9oaXN0b3J5X2VudHJpZXMnLFxuICBDT05GSUc6ICdzdXNmaXRfdHJ5b25faGlzdG9yeV9jb25maWcnLFxuICBNRVRBREFUQTogJ3N1c2ZpdF90cnlvbl9oaXN0b3J5X21ldGFkYXRhJ1xufSBhcyBjb25zdDtcblxuLyoqXG4gKiBHZW5lcmF0ZSBhIHVuaXF1ZSBJRCBmb3IgaGlzdG9yeSBlbnRyaWVzXG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlSGlzdG9yeUlkKCk6IHN0cmluZyB7XG4gIHJldHVybiBgdHJ5b25fJHtEYXRlLm5vdygpfV8ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gO1xufVxuXG4vKipcbiAqIENhbGN1bGF0ZSB0aGUgc2l6ZSBvZiBhIGhpc3RvcnkgZW50cnkgaW4gS0JcbiAqL1xuZnVuY3Rpb24gY2FsY3VsYXRlRW50cnlTaXplKGVudHJ5OiBUcnlvbkhpc3RvcnlFbnRyeSk6IG51bWJlciB7XG4gIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShlbnRyeSk7XG4gIHJldHVybiBuZXcgQmxvYihbanNvbl0pLnNpemUgLyAxMDI0O1xufVxuXG4vKipcbiAqIENvbXByZXNzIGltYWdlcyBpbiBhIGhpc3RvcnkgZW50cnlcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY29tcHJlc3NIaXN0b3J5RW50cnkoXG4gIGVudHJ5OiBUcnlvbkhpc3RvcnlFbnRyeSwgXG4gIGNvbmZpZzogVHJ5b25IaXN0b3J5U3RvcmFnZUNvbmZpZ1xuKTogUHJvbWlzZTxUcnlvbkhpc3RvcnlFbnRyeT4ge1xuICBpZiAoIWNvbmZpZy5jb21wcmVzc0ltYWdlcykge1xuICAgIHJldHVybiBlbnRyeTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgbWF4U2l6ZUtCID0gY29uZmlnLm1heEVudHJ5U2l6ZUtCISAvICgyICsgZW50cnkuYXBwYXJlbEltYWdlcy5sZW5ndGgpO1xuICAgIGNvbnN0IHF1YWxpdHkgPSBjb25maWcuY29tcHJlc3Npb25RdWFsaXR5ITtcblxuICAgIC8vIENvbXByZXNzIGdlbmVyYXRlZCBpbWFnZVxuICAgIGNvbnN0IGNvbXByZXNzZWRHZW5lcmF0ZWQgPSBhd2FpdCBjb21wcmVzc0Jhc2U2NChcbiAgICAgIGVudHJ5LmdlbmVyYXRlZEltYWdlLCBcbiAgICAgIG1heFNpemVLQiwgXG4gICAgICBxdWFsaXR5XG4gICAgKTtcblxuICAgIC8vIENvbXByZXNzIG1vZGVsIGltYWdlXG4gICAgY29uc3QgY29tcHJlc3NlZE1vZGVsID0gYXdhaXQgY29tcHJlc3NCYXNlNjQoXG4gICAgICBlbnRyeS5tb2RlbEltYWdlLCBcbiAgICAgIG1heFNpemVLQiwgXG4gICAgICBxdWFsaXR5XG4gICAgKTtcblxuICAgIC8vIENvbXByZXNzIGFwcGFyZWwgaW1hZ2VzXG4gICAgY29uc3QgY29tcHJlc3NlZEFwcGFyZWwgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIGVudHJ5LmFwcGFyZWxJbWFnZXMubWFwKGltZyA9PiBjb21wcmVzc0Jhc2U2NChpbWcsIG1heFNpemVLQiwgcXVhbGl0eSkpXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5lbnRyeSxcbiAgICAgIGdlbmVyYXRlZEltYWdlOiBjb21wcmVzc2VkR2VuZXJhdGVkLFxuICAgICAgbW9kZWxJbWFnZTogY29tcHJlc3NlZE1vZGVsLFxuICAgICAgYXBwYXJlbEltYWdlczogY29tcHJlc3NlZEFwcGFyZWwsXG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICAuLi5lbnRyeS5tZXRhZGF0YSxcbiAgICAgICAgaW1hZ2VQcm9jZXNzaW5nUmVzdWx0czoge1xuICAgICAgICAgIC4uLmVudHJ5Lm1ldGFkYXRhPy5pbWFnZVByb2Nlc3NpbmdSZXN1bHRzLFxuICAgICAgICAgIGZpbmFsSW1hZ2VTaXplczoge1xuICAgICAgICAgICAgbW9kZWxJbWFnZVNpemU6IGdldEJhc2U2NFNpemUoY29tcHJlc3NlZE1vZGVsKSxcbiAgICAgICAgICAgIGFwcGFyZWxJbWFnZVNpemVzOiBjb21wcmVzc2VkQXBwYXJlbC5tYXAoaW1nID0+IGdldEJhc2U2NFNpemUoaW1nKSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIENvbXByZXNzaW9uRmFpbGVkRXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGNvbXByZXNzIGhpc3RvcnkgZW50cnkgaW1hZ2VzLCB1c2luZyBvcmlnaW5hbCcsIGVycm9yKTtcbiAgICAgIHJldHVybiBlbnRyeTtcbiAgICB9XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuLyoqXG4gKiBsb2NhbFN0b3JhZ2UtYmFzZWQgVHJ5LU9uIEhpc3RvcnkgU2VydmljZSBpbXBsZW1lbnRhdGlvblxuICovXG5leHBvcnQgY2xhc3MgTG9jYWxTdG9yYWdlVHJ5b25IaXN0b3J5U2VydmljZSBpbXBsZW1lbnRzIFRyeW9uSGlzdG9yeVNlcnZpY2Uge1xuICBwcml2YXRlIGNvbmZpZzogUmVxdWlyZWQ8VHJ5b25IaXN0b3J5U3RvcmFnZUNvbmZpZz47XG4gIHByaXZhdGUgaXNJbml0aWFsaXplZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogUGFydGlhbDxUcnlvbkhpc3RvcnlTdG9yYWdlQ29uZmlnPiA9IHt9KSB7XG4gICAgdGhpcy5jb25maWcgPSB7IC4uLkRFRkFVTFRfQ09ORklHLCAuLi5jb25maWcgfTtcbiAgICAvLyBEb24ndCBpbml0aWFsaXplIGltbWVkaWF0ZWx5IC0gZGVmZXIgdW50aWwgZmlyc3QgdXNlXG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSBsb2NhbFN0b3JhZ2Ugc3RvcmFnZSAoY2FsbGVkIGxhemlseSBvbiBmaXJzdCB1c2UpXG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVTdG9yYWdlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgbG9jYWxTdG9yYWdlIGlzIGF2YWlsYWJsZSAoY2xpZW50LXNpZGUgb25seSlcbiAgICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyB8fCAhd2luZG93LmxvY2FsU3RvcmFnZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2xvY2FsU3RvcmFnZSBpcyBub3QgYXZhaWxhYmxlJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEluaXRpYWxpemUgY29uZmlnIGlmIG5vdCBleGlzdHNcbiAgICAgIGlmICghbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVlTLkNPTkZJRykpIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RPUkFHRV9LRVlTLkNPTkZJRywgSlNPTi5zdHJpbmdpZnkodGhpcy5jb25maWcpKTtcbiAgICAgIH1cblxuICAgICAgLy8gSW5pdGlhbGl6ZSBlbnRyaWVzIGFycmF5IGlmIG5vdCBleGlzdHNcbiAgICAgIGlmICghbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVlTLkVOVFJJRVMpKSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZUy5FTlRSSUVTLCBKU09OLnN0cmluZ2lmeShbXSkpO1xuICAgICAgfVxuXG4gICAgICAvLyBJbml0aWFsaXplIG1ldGFkYXRhIGlmIG5vdCBleGlzdHNcbiAgICAgIGlmICghbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVlTLk1FVEFEQVRBKSkge1xuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IHtcbiAgICAgICAgICB2ZXJzaW9uOiAnMS4wLjAnLFxuICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIGxhc3RVcGRhdGVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgfTtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RPUkFHRV9LRVlTLk1FVEFEQVRBLCBKU09OLnN0cmluZ2lmeShtZXRhZGF0YSkpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSBoaXN0b3J5IHN0b3JhZ2U6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdIaXN0b3J5IHN0b3JhZ2UgaW5pdGlhbGl6YXRpb24gZmFpbGVkJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEVuc3VyZSBzdG9yYWdlIGlzIGluaXRpYWxpemVkIGJlZm9yZSB1c2VcbiAgICovXG4gIHByaXZhdGUgZW5zdXJlSW5pdGlhbGl6ZWQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZVN0b3JhZ2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCBzdG9yZWQgZW50cmllcyBmcm9tIGxvY2FsU3RvcmFnZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRTdG9yZWRFbnRyaWVzKCk6IFRyeW9uSGlzdG9yeUVudHJ5W10ge1xuICAgIHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZW50cmllc0pzb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVE9SQUdFX0tFWVMuRU5UUklFUyk7XG4gICAgICByZXR1cm4gZW50cmllc0pzb24gPyBKU09OLnBhcnNlKGVudHJpZXNKc29uKSA6IFtdO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gcGFyc2Ugc3RvcmVkIGVudHJpZXM6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlIGVudHJpZXMgdG8gbG9jYWxTdG9yYWdlXG4gICAqL1xuICBwcml2YXRlIHNhdmVFbnRyaWVzKGVudHJpZXM6IFRyeW9uSGlzdG9yeUVudHJ5W10pOiB2b2lkIHtcbiAgICB0aGlzLmVuc3VyZUluaXRpYWxpemVkKCk7XG4gICAgdHJ5IHtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZUy5FTlRSSUVTLCBKU09OLnN0cmluZ2lmeShlbnRyaWVzKSk7XG4gICAgICBcbiAgICAgIC8vIFVwZGF0ZSBtZXRhZGF0YVxuICAgICAgY29uc3QgbWV0YWRhdGEgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUT1JBR0VfS0VZUy5NRVRBREFUQSkgfHwgJ3t9Jyk7XG4gICAgICBtZXRhZGF0YS5sYXN0VXBkYXRlZCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZUy5NRVRBREFUQSwgSlNPTi5zdHJpbmdpZnkobWV0YWRhdGEpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNhdmUgZW50cmllcyB0byBsb2NhbFN0b3JhZ2U6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gc2F2ZSBoaXN0b3J5IGVudHJpZXMnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBjbGVhbnVwIGlmIG5lZWRlZFxuICAgKi9cbiAgcHJpdmF0ZSBwZXJmb3JtQ2xlYW51cElmTmVlZGVkKGVudHJpZXM6IFRyeW9uSGlzdG9yeUVudHJ5W10pOiBUcnlvbkhpc3RvcnlFbnRyeVtdIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmF1dG9DbGVhbnVwIHx8IGVudHJpZXMubGVuZ3RoIDw9IHRoaXMuY29uZmlnLm1heEVudHJpZXMpIHtcbiAgICAgIHJldHVybiBlbnRyaWVzO1xuICAgIH1cblxuICAgIC8vIFNvcnQgYnkgdGltZXN0YW1wIGFuZCBrZWVwIG9ubHkgdGhlIG1vc3QgcmVjZW50IGVudHJpZXNcbiAgICBjb25zdCBzb3J0ZWQgPSBbLi4uZW50cmllc10uc29ydCgoYSwgYikgPT4gXG4gICAgICBuZXcgRGF0ZShiLnRpbWVzdGFtcCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYS50aW1lc3RhbXApLmdldFRpbWUoKVxuICAgICk7XG4gICAgXG4gICAgcmV0dXJuIHNvcnRlZC5zbGljZSgwLCB0aGlzLmNvbmZpZy5tYXhFbnRyaWVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGaWx0ZXIgYW5kIHNvcnQgZW50cmllcyBiYXNlZCBvbiBxdWVyeSBvcHRpb25zXG4gICAqL1xuICBwcml2YXRlIGZpbHRlckFuZFNvcnRFbnRyaWVzKFxuICAgIGVudHJpZXM6IFRyeW9uSGlzdG9yeUVudHJ5W10sIFxuICAgIG9wdGlvbnM6IFRyeW9uSGlzdG9yeVF1ZXJ5T3B0aW9ucyA9IHt9XG4gICk6IFRyeW9uSGlzdG9yeUVudHJ5W10ge1xuICAgIGxldCBmaWx0ZXJlZCA9IFsuLi5lbnRyaWVzXTtcblxuICAgIC8vIEFwcGx5IGZhdm9yaXRlcyBmaWx0ZXJcbiAgICBpZiAob3B0aW9ucy5mYXZvcml0ZXNPbmx5KSB7XG4gICAgICBmaWx0ZXJlZCA9IGZpbHRlcmVkLmZpbHRlcihlbnRyeSA9PiBlbnRyeS5pc0Zhdm9yaXRlKTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSBkYXRlIHJhbmdlIGZpbHRlclxuICAgIGlmIChvcHRpb25zLmRhdGVSYW5nZSkge1xuICAgICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUob3B0aW9ucy5kYXRlUmFuZ2Uuc3RhcnREYXRlKTtcbiAgICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZShvcHRpb25zLmRhdGVSYW5nZS5lbmREYXRlKTtcbiAgICAgIGZpbHRlcmVkID0gZmlsdGVyZWQuZmlsdGVyKGVudHJ5ID0+IHtcbiAgICAgICAgY29uc3QgZW50cnlEYXRlID0gbmV3IERhdGUoZW50cnkudGltZXN0YW1wKTtcbiAgICAgICAgcmV0dXJuIGVudHJ5RGF0ZSA+PSBzdGFydERhdGUgJiYgZW50cnlEYXRlIDw9IGVuZERhdGU7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSBzZWFyY2ggdGVybSBmaWx0ZXJcbiAgICBpZiAob3B0aW9ucy5zZWFyY2hUZXJtKSB7XG4gICAgICBjb25zdCBzZWFyY2hUZXJtID0gb3B0aW9ucy5zZWFyY2hUZXJtLnRvTG93ZXJDYXNlKCk7XG4gICAgICBmaWx0ZXJlZCA9IGZpbHRlcmVkLmZpbHRlcihlbnRyeSA9PiBcbiAgICAgICAgZW50cnkudGFncz8uc29tZSh0YWcgPT4gdGFnLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoc2VhcmNoVGVybSkpIHx8XG4gICAgICAgIGVudHJ5Lm5vdGVzPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHNlYXJjaFRlcm0pXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEFwcGx5IHNvcnRpbmdcbiAgICBjb25zdCBzb3J0QnkgPSBvcHRpb25zLnNvcnRCeSB8fCAndGltZXN0YW1wJztcbiAgICBjb25zdCBzb3J0RGlyZWN0aW9uID0gb3B0aW9ucy5zb3J0RGlyZWN0aW9uIHx8ICdkZXNjJztcbiAgICBcbiAgICBmaWx0ZXJlZC5zb3J0KChhLCBiKSA9PiB7XG4gICAgICBsZXQgYVZhbHVlOiBEYXRlIHwgbnVtYmVyLCBiVmFsdWU6IERhdGUgfCBudW1iZXI7XG4gICAgICBcbiAgICAgIHN3aXRjaCAoc29ydEJ5KSB7XG4gICAgICAgIGNhc2UgJ3RpbWVzdGFtcCc6XG4gICAgICAgICAgYVZhbHVlID0gbmV3IERhdGUoYS50aW1lc3RhbXApO1xuICAgICAgICAgIGJWYWx1ZSA9IG5ldyBEYXRlKGIudGltZXN0YW1wKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAncHJvY2Vzc2luZ1RpbWUnOlxuICAgICAgICAgIGFWYWx1ZSA9IGEucHJvY2Vzc2luZ1RpbWUgfHwgMDtcbiAgICAgICAgICBiVmFsdWUgPSBiLnByb2Nlc3NpbmdUaW1lIHx8IDA7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2lzRmF2b3JpdGUnOlxuICAgICAgICAgIGFWYWx1ZSA9IGEuaXNGYXZvcml0ZSA/IDEgOiAwO1xuICAgICAgICAgIGJWYWx1ZSA9IGIuaXNGYXZvcml0ZSA/IDEgOiAwO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGFWYWx1ZSA9IGEudGltZXN0YW1wO1xuICAgICAgICAgIGJWYWx1ZSA9IGIudGltZXN0YW1wO1xuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoc29ydERpcmVjdGlvbiA9PT0gJ2FzYycpIHtcbiAgICAgICAgcmV0dXJuIGFWYWx1ZSA8IGJWYWx1ZSA/IC0xIDogYVZhbHVlID4gYlZhbHVlID8gMSA6IDA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gYVZhbHVlID4gYlZhbHVlID8gLTEgOiBhVmFsdWUgPCBiVmFsdWUgPyAxIDogMDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBmaWx0ZXJlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBuZXcgaGlzdG9yeSBlbnRyeVxuICAgKi9cbiAgYXN5bmMgYWRkRW50cnkob3B0aW9uczogQ3JlYXRlVHJ5b25IaXN0b3J5RW50cnlPcHRpb25zKTogUHJvbWlzZTxUcnlvbkhpc3RvcnlFbnRyeT4ge1xuICAgIGNvbnN0IGVudHJ5OiBUcnlvbkhpc3RvcnlFbnRyeSA9IHtcbiAgICAgIGlkOiBnZW5lcmF0ZUhpc3RvcnlJZCgpLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICBnZW5lcmF0ZWRJbWFnZTogb3B0aW9ucy5nZW5lcmF0ZWRJbWFnZSxcbiAgICAgIG1vZGVsSW1hZ2U6IG9wdGlvbnMubW9kZWxJbWFnZSxcbiAgICAgIGFwcGFyZWxJbWFnZXM6IG9wdGlvbnMuYXBwYXJlbEltYWdlcyxcbiAgICAgIHByb2Nlc3NpbmdUaW1lOiBvcHRpb25zLnByb2Nlc3NpbmdUaW1lLFxuICAgICAgbWV0YWRhdGE6IG9wdGlvbnMubWV0YWRhdGEsXG4gICAgICB0YWdzOiBvcHRpb25zLnRhZ3MgfHwgW10sXG4gICAgICBpc0Zhdm9yaXRlOiBvcHRpb25zLmlzRmF2b3JpdGUgfHwgZmFsc2UsXG4gICAgICBub3Rlczogb3B0aW9ucy5ub3RlcyB8fCAnJ1xuICAgIH07XG5cbiAgICAvLyBDb21wcmVzcyBlbnRyeSBpZiBlbmFibGVkXG4gICAgY29uc3QgY29tcHJlc3NlZEVudHJ5ID0gYXdhaXQgY29tcHJlc3NIaXN0b3J5RW50cnkoZW50cnksIHRoaXMuY29uZmlnKTtcblxuICAgIC8vIENoZWNrIGVudHJ5IHNpemVcbiAgICBjb25zdCBlbnRyeVNpemUgPSBjYWxjdWxhdGVFbnRyeVNpemUoY29tcHJlc3NlZEVudHJ5KTtcbiAgICBpZiAoZW50cnlTaXplID4gdGhpcy5jb25maWcubWF4RW50cnlTaXplS0IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEhpc3RvcnkgZW50cnkgdG9vIGxhcmdlOiAke2VudHJ5U2l6ZS50b0ZpeGVkKDIpfUtCIGV4Y2VlZHMgbGltaXQgb2YgJHt0aGlzLmNvbmZpZy5tYXhFbnRyeVNpemVLQn1LQmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gR2V0IGN1cnJlbnQgZW50cmllcyBhbmQgYWRkIHRoZSBuZXcgb25lXG4gICAgbGV0IGVudHJpZXMgPSB0aGlzLmdldFN0b3JlZEVudHJpZXMoKTtcbiAgICBlbnRyaWVzLnB1c2goY29tcHJlc3NlZEVudHJ5KTtcblxuICAgIC8vIFBlcmZvcm0gY2xlYW51cCBpZiBuZWVkZWRcbiAgICBlbnRyaWVzID0gdGhpcy5wZXJmb3JtQ2xlYW51cElmTmVlZGVkKGVudHJpZXMpO1xuXG4gICAgLy8gU2F2ZSB1cGRhdGVkIGVudHJpZXNcbiAgICB0aGlzLnNhdmVFbnRyaWVzKGVudHJpZXMpO1xuXG4gICAgcmV0dXJuIGNvbXByZXNzZWRFbnRyeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgaGlzdG9yeSBlbnRyaWVzIHdpdGggZmlsdGVyaW5nIGFuZCBwYWdpbmF0aW9uXG4gICAqL1xuICBhc3luYyBnZXRFbnRyaWVzKG9wdGlvbnM6IFRyeW9uSGlzdG9yeVF1ZXJ5T3B0aW9ucyA9IHt9KTogUHJvbWlzZTxUcnlvbkhpc3RvcnlDb2xsZWN0aW9uPiB7XG4gICAgY29uc3QgYWxsRW50cmllcyA9IHRoaXMuZ2V0U3RvcmVkRW50cmllcygpO1xuICAgIGNvbnN0IGZpbHRlcmVkRW50cmllcyA9IHRoaXMuZmlsdGVyQW5kU29ydEVudHJpZXMoYWxsRW50cmllcywgb3B0aW9ucyk7XG5cbiAgICAvLyBBcHBseSBwYWdpbmF0aW9uXG4gICAgY29uc3QgcGFnZSA9IG9wdGlvbnMucGFnZSB8fCAwO1xuICAgIGNvbnN0IHBhZ2VTaXplID0gb3B0aW9ucy5wYWdlU2l6ZSB8fCAyMDtcbiAgICBjb25zdCBzdGFydEluZGV4ID0gcGFnZSAqIHBhZ2VTaXplO1xuICAgIGNvbnN0IGVuZEluZGV4ID0gc3RhcnRJbmRleCArIHBhZ2VTaXplO1xuICAgIGNvbnN0IHBhZ2luYXRlZEVudHJpZXMgPSBmaWx0ZXJlZEVudHJpZXMuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGVudHJpZXM6IHBhZ2luYXRlZEVudHJpZXMsXG4gICAgICB0b3RhbENvdW50OiBmaWx0ZXJlZEVudHJpZXMubGVuZ3RoLFxuICAgICAgY3VycmVudFBhZ2U6IHBhZ2UsXG4gICAgICBwYWdlU2l6ZSxcbiAgICAgIGhhc01vcmU6IGVuZEluZGV4IDwgZmlsdGVyZWRFbnRyaWVzLmxlbmd0aCxcbiAgICAgIGxhc3RVcGRhdGVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHNwZWNpZmljIGhpc3RvcnkgZW50cnkgYnkgSURcbiAgICovXG4gIGFzeW5jIGdldEVudHJ5KGlkOiBzdHJpbmcpOiBQcm9taXNlPFRyeW9uSGlzdG9yeUVudHJ5IHwgbnVsbD4ge1xuICAgIGNvbnN0IGVudHJpZXMgPSB0aGlzLmdldFN0b3JlZEVudHJpZXMoKTtcbiAgICByZXR1cm4gZW50cmllcy5maW5kKGVudHJ5ID0+IGVudHJ5LmlkID09PSBpZCkgfHwgbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgaGlzdG9yeSBlbnRyeVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlRW50cnkoaWQ6IHN0cmluZywgdXBkYXRlczogUGFydGlhbDxUcnlvbkhpc3RvcnlFbnRyeT4pOiBQcm9taXNlPFRyeW9uSGlzdG9yeUVudHJ5PiB7XG4gICAgY29uc3QgZW50cmllcyA9IHRoaXMuZ2V0U3RvcmVkRW50cmllcygpO1xuICAgIGNvbnN0IGVudHJ5SW5kZXggPSBlbnRyaWVzLmZpbmRJbmRleChlbnRyeSA9PiBlbnRyeS5pZCA9PT0gaWQpO1xuICAgIFxuICAgIGlmIChlbnRyeUluZGV4ID09PSAtMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBIaXN0b3J5IGVudHJ5IHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgdXBkYXRlc1xuICAgIGNvbnN0IHVwZGF0ZWRFbnRyeSA9IHsgXG4gICAgICAuLi5lbnRyaWVzW2VudHJ5SW5kZXhdLCBcbiAgICAgIC4uLnVwZGF0ZXMsXG4gICAgICAvLyBQcmVzZXJ2ZSBJRCBhbmQgdGltZXN0YW1wLCB1cGRhdGUgb25seSBpZiBleHBsaWNpdGx5IHByb3ZpZGVkXG4gICAgICBpZDogZW50cmllc1tlbnRyeUluZGV4XS5pZCxcbiAgICAgIHRpbWVzdGFtcDogdXBkYXRlcy50aW1lc3RhbXAgfHwgZW50cmllc1tlbnRyeUluZGV4XS50aW1lc3RhbXBcbiAgICB9O1xuXG4gICAgZW50cmllc1tlbnRyeUluZGV4XSA9IHVwZGF0ZWRFbnRyeTtcbiAgICB0aGlzLnNhdmVFbnRyaWVzKGVudHJpZXMpO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRFbnRyeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYSBoaXN0b3J5IGVudHJ5XG4gICAqL1xuICBhc3luYyBkZWxldGVFbnRyeShpZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZW50cmllcyA9IHRoaXMuZ2V0U3RvcmVkRW50cmllcygpO1xuICAgIGNvbnN0IGZpbHRlcmVkRW50cmllcyA9IGVudHJpZXMuZmlsdGVyKGVudHJ5ID0+IGVudHJ5LmlkICE9PSBpZCk7XG4gICAgXG4gICAgaWYgKGZpbHRlcmVkRW50cmllcy5sZW5ndGggPT09IGVudHJpZXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gZmFsc2U7IC8vIEVudHJ5IG5vdCBmb3VuZFxuICAgIH1cblxuICAgIHRoaXMuc2F2ZUVudHJpZXMoZmlsdGVyZWRFbnRyaWVzKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBhbGwgaGlzdG9yeSBlbnRyaWVzXG4gICAqL1xuICBhc3luYyBjbGVhckFsbCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0aGlzLmVuc3VyZUluaXRpYWxpemVkKCk7XG4gICAgdHJ5IHtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZUy5FTlRSSUVTLCBKU09OLnN0cmluZ2lmeShbXSkpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBjbGVhciBoaXN0b3J5OicsIGVycm9yKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN0b3JhZ2Ugc3RhdGlzdGljc1xuICAgKi9cbiAgYXN5bmMgZ2V0U3RvcmFnZVN0YXRzKCk6IFByb21pc2U8e1xuICAgIHRvdGFsRW50cmllczogbnVtYmVyO1xuICAgIHRvdGFsU2l6ZUtCOiBudW1iZXI7XG4gICAgb2xkZXN0RW50cnk/OiBzdHJpbmc7XG4gICAgbmV3ZXN0RW50cnk/OiBzdHJpbmc7XG4gIH0+IHtcbiAgICBjb25zdCBlbnRyaWVzID0gdGhpcy5nZXRTdG9yZWRFbnRyaWVzKCk7XG4gICAgXG4gICAgbGV0IHRvdGFsU2l6ZUtCID0gMDtcbiAgICBlbnRyaWVzLmZvckVhY2goZW50cnkgPT4ge1xuICAgICAgdG90YWxTaXplS0IgKz0gY2FsY3VsYXRlRW50cnlTaXplKGVudHJ5KTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHRpbWVzdGFtcHMgPSBlbnRyaWVzLm1hcChlbnRyeSA9PiBlbnRyeS50aW1lc3RhbXApLnNvcnQoKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxFbnRyaWVzOiBlbnRyaWVzLmxlbmd0aCxcbiAgICAgIHRvdGFsU2l6ZUtCLFxuICAgICAgb2xkZXN0RW50cnk6IHRpbWVzdGFtcHNbMF0sXG4gICAgICBuZXdlc3RFbnRyeTogdGltZXN0YW1wc1t0aW1lc3RhbXBzLmxlbmd0aCAtIDFdXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHBvcnQgaGlzdG9yeSBkYXRhXG4gICAqL1xuICBhc3luYyBleHBvcnRIaXN0b3J5KCk6IFByb21pc2U8VHJ5b25IaXN0b3J5RW50cnlbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldFN0b3JlZEVudHJpZXMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbXBvcnQgaGlzdG9yeSBkYXRhXG4gICAqL1xuICBhc3luYyBpbXBvcnRIaXN0b3J5KGVudHJpZXM6IFRyeW9uSGlzdG9yeUVudHJ5W10pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBWYWxpZGF0ZSBlbnRyaWVzXG4gICAgICBjb25zdCB2YWxpZEVudHJpZXMgPSBlbnRyaWVzLmZpbHRlcihlbnRyeSA9PiBcbiAgICAgICAgZW50cnkuaWQgJiYgZW50cnkuZ2VuZXJhdGVkSW1hZ2UgJiYgZW50cnkubW9kZWxJbWFnZSAmJiBlbnRyeS5hcHBhcmVsSW1hZ2VzXG4gICAgICApO1xuXG4gICAgICAvLyBHZXQgZXhpc3RpbmcgZW50cmllcyBhbmQgbWVyZ2Ugd2l0aCBpbXBvcnRzXG4gICAgICBjb25zdCBleGlzdGluZ0VudHJpZXMgPSB0aGlzLmdldFN0b3JlZEVudHJpZXMoKTtcbiAgICAgIGNvbnN0IGV4aXN0aW5nSWRzID0gbmV3IFNldChleGlzdGluZ0VudHJpZXMubWFwKGVudHJ5ID0+IGVudHJ5LmlkKSk7XG4gICAgICBcbiAgICAgIC8vIE9ubHkgaW1wb3J0IGVudHJpZXMgdGhhdCBkb24ndCBhbHJlYWR5IGV4aXN0XG4gICAgICBjb25zdCBuZXdFbnRyaWVzID0gdmFsaWRFbnRyaWVzLmZpbHRlcihlbnRyeSA9PiAhZXhpc3RpbmdJZHMuaGFzKGVudHJ5LmlkKSk7XG4gICAgICBcbiAgICAgIGlmIChuZXdFbnRyaWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICAgIH1cblxuICAgICAgLy8gTWVyZ2UgYW5kIHNhdmVcbiAgICAgIGNvbnN0IG1lcmdlZEVudHJpZXMgPSBbLi4uZXhpc3RpbmdFbnRyaWVzLCAuLi5uZXdFbnRyaWVzXTtcbiAgICAgIGNvbnN0IGNsZWFuZWRFbnRyaWVzID0gdGhpcy5wZXJmb3JtQ2xlYW51cElmTmVlZGVkKG1lcmdlZEVudHJpZXMpO1xuICAgICAgXG4gICAgICB0aGlzLnNhdmVFbnRyaWVzKGNsZWFuZWRFbnRyaWVzKTtcbiAgICAgIHJldHVybiBuZXdFbnRyaWVzLmxlbmd0aDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGltcG9ydCBoaXN0b3J5OicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSGlzdG9yeSBpbXBvcnQgZmFpbGVkJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBzZXJ2aWNlIGNvbmZpZ3VyYXRpb25cbiAgICovXG4gIHVwZGF0ZUNvbmZpZyhuZXdDb25maWc6IFBhcnRpYWw8VHJ5b25IaXN0b3J5U3RvcmFnZUNvbmZpZz4pOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZyA9IHsgLi4udGhpcy5jb25maWcsIC4uLm5ld0NvbmZpZyB9O1xuICAgIFxuICAgIHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcbiAgICB0cnkge1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RPUkFHRV9LRVlTLkNPTkZJRywgSlNPTi5zdHJpbmdpZnkodGhpcy5jb25maWcpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNhdmUgY29uZmlnOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGN1cnJlbnQgY29uZmlndXJhdGlvblxuICAgKi9cbiAgZ2V0Q29uZmlnKCk6IFRyeW9uSGlzdG9yeVN0b3JhZ2VDb25maWcge1xuICAgIHJldHVybiB7IC4uLnRoaXMuY29uZmlnIH07XG4gIH1cbn1cblxuLyoqXG4gKiBEZWZhdWx0IGhpc3Rvcnkgc2VydmljZSBpbnN0YW5jZVxuICovXG5leHBvcnQgY29uc3QgZGVmYXVsdEhpc3RvcnlTZXJ2aWNlID0gbmV3IExvY2FsU3RvcmFnZVRyeW9uSGlzdG9yeVNlcnZpY2UoKTsiXSwibmFtZXMiOlsiTG9jYWxTdG9yYWdlVHJ5b25IaXN0b3J5U2VydmljZSIsImRlZmF1bHRIaXN0b3J5U2VydmljZSIsIkRFRkFVTFRfQ09ORklHIiwic3RvcmFnZVR5cGUiLCJtYXhFbnRyaWVzIiwibWF4RW50cnlTaXplS0IiLCJjb21wcmVzc0ltYWdlcyIsImNvbXByZXNzaW9uUXVhbGl0eSIsImF1dG9DbGVhbnVwIiwiZW5jcnlwdGlvbktleSIsIlNUT1JBR0VfS0VZUyIsIkVOVFJJRVMiLCJDT05GSUciLCJNRVRBREFUQSIsImdlbmVyYXRlSGlzdG9yeUlkIiwiRGF0ZSIsIm5vdyIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0ciIsImNhbGN1bGF0ZUVudHJ5U2l6ZSIsImVudHJ5IiwianNvbiIsIkpTT04iLCJzdHJpbmdpZnkiLCJCbG9iIiwic2l6ZSIsImNvbXByZXNzSGlzdG9yeUVudHJ5IiwiY29uZmlnIiwibWF4U2l6ZUtCIiwiYXBwYXJlbEltYWdlcyIsImxlbmd0aCIsInF1YWxpdHkiLCJjb21wcmVzc2VkR2VuZXJhdGVkIiwiY29tcHJlc3NCYXNlNjQiLCJnZW5lcmF0ZWRJbWFnZSIsImNvbXByZXNzZWRNb2RlbCIsIm1vZGVsSW1hZ2UiLCJjb21wcmVzc2VkQXBwYXJlbCIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJpbWciLCJtZXRhZGF0YSIsImltYWdlUHJvY2Vzc2luZ1Jlc3VsdHMiLCJmaW5hbEltYWdlU2l6ZXMiLCJtb2RlbEltYWdlU2l6ZSIsImdldEJhc2U2NFNpemUiLCJhcHBhcmVsSW1hZ2VTaXplcyIsImVycm9yIiwiQ29tcHJlc3Npb25GYWlsZWRFcnJvciIsImNvbnNvbGUiLCJ3YXJuIiwiY29uc3RydWN0b3IiLCJpc0luaXRpYWxpemVkIiwiaW5pdGlhbGl6ZVN0b3JhZ2UiLCJ3aW5kb3ciLCJsb2NhbFN0b3JhZ2UiLCJFcnJvciIsImdldEl0ZW0iLCJzZXRJdGVtIiwidmVyc2lvbiIsImNyZWF0ZWRBdCIsInRvSVNPU3RyaW5nIiwibGFzdFVwZGF0ZWQiLCJlbnN1cmVJbml0aWFsaXplZCIsImdldFN0b3JlZEVudHJpZXMiLCJlbnRyaWVzSnNvbiIsInBhcnNlIiwic2F2ZUVudHJpZXMiLCJlbnRyaWVzIiwicGVyZm9ybUNsZWFudXBJZk5lZWRlZCIsInNvcnRlZCIsInNvcnQiLCJhIiwiYiIsInRpbWVzdGFtcCIsImdldFRpbWUiLCJzbGljZSIsImZpbHRlckFuZFNvcnRFbnRyaWVzIiwib3B0aW9ucyIsImZpbHRlcmVkIiwiZmF2b3JpdGVzT25seSIsImZpbHRlciIsImlzRmF2b3JpdGUiLCJkYXRlUmFuZ2UiLCJzdGFydERhdGUiLCJlbmREYXRlIiwiZW50cnlEYXRlIiwic2VhcmNoVGVybSIsInRvTG93ZXJDYXNlIiwidGFncyIsInNvbWUiLCJ0YWciLCJpbmNsdWRlcyIsIm5vdGVzIiwic29ydEJ5Iiwic29ydERpcmVjdGlvbiIsImFWYWx1ZSIsImJWYWx1ZSIsInByb2Nlc3NpbmdUaW1lIiwiYWRkRW50cnkiLCJpZCIsImNvbXByZXNzZWRFbnRyeSIsImVudHJ5U2l6ZSIsInRvRml4ZWQiLCJwdXNoIiwiZ2V0RW50cmllcyIsImFsbEVudHJpZXMiLCJmaWx0ZXJlZEVudHJpZXMiLCJwYWdlIiwicGFnZVNpemUiLCJzdGFydEluZGV4IiwiZW5kSW5kZXgiLCJwYWdpbmF0ZWRFbnRyaWVzIiwidG90YWxDb3VudCIsImN1cnJlbnRQYWdlIiwiaGFzTW9yZSIsImdldEVudHJ5IiwiZmluZCIsInVwZGF0ZUVudHJ5IiwidXBkYXRlcyIsImVudHJ5SW5kZXgiLCJmaW5kSW5kZXgiLCJ1cGRhdGVkRW50cnkiLCJkZWxldGVFbnRyeSIsImNsZWFyQWxsIiwiZ2V0U3RvcmFnZVN0YXRzIiwidG90YWxTaXplS0IiLCJmb3JFYWNoIiwidGltZXN0YW1wcyIsInRvdGFsRW50cmllcyIsIm9sZGVzdEVudHJ5IiwibmV3ZXN0RW50cnkiLCJleHBvcnRIaXN0b3J5IiwiaW1wb3J0SGlzdG9yeSIsInZhbGlkRW50cmllcyIsImV4aXN0aW5nRW50cmllcyIsImV4aXN0aW5nSWRzIiwiU2V0IiwibmV3RW50cmllcyIsImhhcyIsIm1lcmdlZEVudHJpZXMiLCJjbGVhbmVkRW50cmllcyIsInVwZGF0ZUNvbmZpZyIsIm5ld0NvbmZpZyIsImdldENvbmZpZyJdLCJtYXBwaW5ncyI6IkFBQUEsaUNBQWlDO0FBQ2pDLHVGQUF1Rjs7Ozs7Ozs7Ozs7O0lBbUgxRUEsK0JBQStCO2VBQS9CQTs7SUEwWUFDLHFCQUFxQjtlQUFyQkE7OztpQ0F2Zk47QUFVUDs7Q0FFQyxHQUNELE1BQU1DLGlCQUFzRDtJQUMxREMsYUFBYTtJQUNi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