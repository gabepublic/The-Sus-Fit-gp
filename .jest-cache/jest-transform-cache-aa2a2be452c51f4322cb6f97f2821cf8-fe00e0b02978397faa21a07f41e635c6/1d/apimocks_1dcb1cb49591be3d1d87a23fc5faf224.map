{"version":3,"sources":["/Users/willstreeter/WebstormProjects/vibe-coding/those-people/The-Sus-Fit-gp/__tests__/test-utils/api-mocks.ts"],"sourcesContent":["/**\n * API Mocks using MSW (Mock Service Worker)\n * Comprehensive mocking strategies for external API calls\n */\n\nimport { http, HttpResponse, delay } from 'msw';\nimport { setupServer } from 'msw/node';\n\n/**\n * Mock response types\n */\nexport interface MockTryonResponse {\n  img_generated: string;\n  metadata?: {\n    processingTime: number;\n    modelVersion: string;\n    timestamp: string;\n  };\n}\n\nexport interface MockErrorResponse {\n  error: string;\n  details?: string;\n  code?: string;\n}\n\n/**\n * Default mock responses\n */\nexport const DEFAULT_MOCK_RESPONSES = {\n  success: {\n    img_generated: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAAAAAAAMockGeneratedImageData==',\n    metadata: {\n      processingTime: 2500,\n      modelVersion: 'v1.2.0',\n      timestamp: new Date().toISOString(),\n    },\n  } as MockTryonResponse,\n  \n  error: {\n    error: 'Internal Server Error',\n    details: 'Failed to process try-on request',\n    code: 'PROCESSING_ERROR',\n  } as MockErrorResponse,\n  \n  validation: {\n    error: 'Validation Error',\n    details: 'Invalid image format or size',\n    code: 'VALIDATION_ERROR',\n  } as MockErrorResponse,\n  \n  timeout: {\n    error: 'Request Timeout',\n    details: 'Processing took too long',\n    code: 'TIMEOUT_ERROR',\n  } as MockErrorResponse,\n  \n  rateLimit: {\n    error: 'Too Many Requests',\n    details: 'Rate limit exceeded',\n    code: 'RATE_LIMIT_ERROR',\n  } as MockErrorResponse,\n};\n\n/**\n * API endpoint configurations\n */\nexport const API_ENDPOINTS = {\n  tryon: '/api/tryon',\n  health: '/api/health',\n  upload: '/api/upload',\n} as const;\n\n/**\n * MSW request handlers\n */\nexport const handlers = [\n  // Try-on API endpoint - success case\n  http.post(API_ENDPOINTS.tryon, async ({ request }) => {\n    const body = await request.json() as any;\n    \n    // Validate request structure\n    if (!body.modelImage || !body.apparelImages || !Array.isArray(body.apparelImages)) {\n      return HttpResponse.json(DEFAULT_MOCK_RESPONSES.validation, { status: 400 });\n    }\n    \n    // Simulate processing delay\n    await delay(100);\n    \n    return HttpResponse.json(DEFAULT_MOCK_RESPONSES.success);\n  }),\n\n  // Health check endpoint\n  http.get(API_ENDPOINTS.health, () => {\n    return HttpResponse.json({ status: 'ok', timestamp: new Date().toISOString() });\n  }),\n\n  // File upload endpoint\n  http.post(API_ENDPOINTS.upload, async ({ request }) => {\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n    \n    if (!file) {\n      return HttpResponse.json({ error: 'No file provided' }, { status: 400 });\n    }\n    \n    return HttpResponse.json({\n      url: `mock-url://uploaded-${file.name}`,\n      size: file.size,\n      type: file.type,\n    });\n  }),\n];\n\n/**\n * Error scenario handlers\n */\nexport const errorHandlers = {\n  // Server error (500)\n  serverError: http.post(API_ENDPOINTS.tryon, () => {\n    return HttpResponse.json(DEFAULT_MOCK_RESPONSES.error, { status: 500 });\n  }),\n\n  // Validation error (400)\n  validationError: http.post(API_ENDPOINTS.tryon, () => {\n    return HttpResponse.json(DEFAULT_MOCK_RESPONSES.validation, { status: 400 });\n  }),\n\n  // Timeout simulation\n  timeout: http.post(API_ENDPOINTS.tryon, async () => {\n    await delay(30000); // Simulate very slow response\n    return HttpResponse.json(DEFAULT_MOCK_RESPONSES.timeout, { status: 408 });\n  }),\n\n  // Rate limiting (429)\n  rateLimit: http.post(API_ENDPOINTS.tryon, () => {\n    return HttpResponse.json(DEFAULT_MOCK_RESPONSES.rateLimit, { status: 429 });\n  }),\n\n  // Network error\n  networkError: http.post(API_ENDPOINTS.tryon, () => {\n    return HttpResponse.error();\n  }),\n\n  // Invalid JSON response\n  invalidJson: http.post(API_ENDPOINTS.tryon, () => {\n    return new HttpResponse('invalid json response', {\n      status: 200,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  }),\n\n  // Missing required fields in response\n  incompleteResponse: http.post(API_ENDPOINTS.tryon, () => {\n    return HttpResponse.json({ metadata: { processingTime: 1000 } }, { status: 200 });\n  }),\n};\n\n/**\n * Performance scenario handlers\n */\nexport const performanceHandlers = {\n  // Fast response (< 100ms)\n  fast: http.post(API_ENDPOINTS.tryon, async () => {\n    await delay(50);\n    return HttpResponse.json(DEFAULT_MOCK_RESPONSES.success);\n  }),\n\n  // Slow response (> 5s)\n  slow: http.post(API_ENDPOINTS.tryon, async () => {\n    await delay(5000);\n    return HttpResponse.json(DEFAULT_MOCK_RESPONSES.success);\n  }),\n\n  // Variable response times\n  variable: http.post(API_ENDPOINTS.tryon, async () => {\n    const delays = [100, 500, 1000, 2000, 3000];\n    const randomDelay = delays[Math.floor(Math.random() * delays.length)];\n    await delay(randomDelay);\n    return HttpResponse.json({\n      ...DEFAULT_MOCK_RESPONSES.success,\n      metadata: {\n        ...DEFAULT_MOCK_RESPONSES.success.metadata!,\n        processingTime: randomDelay,\n      },\n    });\n  }),\n};\n\n/**\n * Test server setup\n */\nexport const server = setupServer(...handlers);\n\n/**\n * Mock API utilities\n */\nexport class MockAPIUtils {\n  /**\n   * Setup MSW server for tests\n   */\n  static setupServer() {\n    // Enable API mocking before all tests\n    beforeAll(() => server.listen({ onUnhandledRequest: 'error' }));\n    \n    // Reset handlers after each test\n    afterEach(() => server.resetHandlers());\n    \n    // Clean up after all tests\n    afterAll(() => server.close());\n  }\n\n  /**\n   * Use specific error scenario\n   */\n  static useErrorScenario(scenario: keyof typeof errorHandlers) {\n    server.use(errorHandlers[scenario]);\n  }\n\n  /**\n   * Use specific performance scenario\n   */\n  static usePerformanceScenario(scenario: keyof typeof performanceHandlers) {\n    server.use(performanceHandlers[scenario]);\n  }\n\n  /**\n   * Use custom handler\n   */\n  static useCustomHandler(handler: Parameters<typeof server.use>[0]) {\n    server.use(handler);\n  }\n\n  /**\n   * Create custom try-on response\n   */\n  static createCustomTryonHandler(\n    response: Partial<MockTryonResponse>,\n    options: {\n      status?: number;\n      delay?: number;\n      shouldFail?: boolean;\n    } = {}\n  ) {\n    const { status = 200, delay: delayMs = 0, shouldFail = false } = options;\n    \n    return http.post(API_ENDPOINTS.tryon, async () => {\n      if (delayMs > 0) {\n        await delay(delayMs);\n      }\n      \n      if (shouldFail) {\n        return HttpResponse.json(DEFAULT_MOCK_RESPONSES.error, { status: 500 });\n      }\n      \n      const fullResponse = {\n        ...DEFAULT_MOCK_RESPONSES.success,\n        ...response,\n      };\n      \n      return HttpResponse.json(fullResponse, { status });\n    });\n  }\n\n  /**\n   * Verify API calls\n   */\n  static getApiCalls(): Array<{\n    method: string;\n    url: string;\n    body?: any;\n    timestamp: number;\n  }> {\n    // Note: This would require implementing call tracking in the handlers\n    // For now, return empty array - could be enhanced with call tracking\n    return [];\n  }\n\n  /**\n   * Reset all mocks and call history\n   */\n  static reset() {\n    server.resetHandlers();\n  }\n\n  /**\n   * Create mock file upload handler\n   */\n  static createFileUploadHandler(\n    response: any = { url: 'mock-upload-url' },\n    options: { status?: number; delay?: number } = {}\n  ) {\n    const { status = 200, delay: delayMs = 0 } = options;\n    \n    return http.post(API_ENDPOINTS.upload, async ({ request }) => {\n      if (delayMs > 0) {\n        await delay(delayMs);\n      }\n      \n      const formData = await request.formData();\n      const file = formData.get('file') as File;\n      \n      return HttpResponse.json({\n        ...response,\n        originalName: file?.name,\n        size: file?.size,\n        type: file?.type,\n      }, { status });\n    });\n  }\n}\n\n/**\n * OpenAI API mocks (if needed for testing external integrations)\n */\nexport const openAIMocks = {\n  // Mock OpenAI API responses\n  completion: http.post('https://api.openai.com/v1/completions', () => {\n    return HttpResponse.json({\n      id: 'cmpl-mock',\n      object: 'text_completion',\n      created: Date.now(),\n      model: 'gpt-3.5-turbo',\n      choices: [{\n        text: 'Mock completion response',\n        index: 0,\n        logprobs: null,\n        finish_reason: 'stop',\n      }],\n    });\n  }),\n\n  // Mock image generation\n  imageGeneration: http.post('https://api.openai.com/v1/images/generations', () => {\n    return HttpResponse.json({\n      created: Date.now(),\n      data: [{\n        url: 'https://mock-image-url.com/generated-image.png',\n      }],\n    });\n  }),\n};\n\n/**\n * Export everything\n */\nexport {\n  server,\n  handlers,\n  errorHandlers,\n  performanceHandlers,\n  MockAPIUtils,\n  openAIMocks,\n};\n\n/**\n * Default export\n */\nexport default {\n  server,\n  handlers,\n  errorHandlers,\n  performanceHandlers,\n  MockAPIUtils,\n  openAIMocks,\n  DEFAULT_MOCK_RESPONSES,\n  API_ENDPOINTS,\n};"],"names":["API_ENDPOINTS","DEFAULT_MOCK_RESPONSES","MockAPIUtils","errorHandlers","handlers","openAIMocks","performanceHandlers","server","success","img_generated","metadata","processingTime","modelVersion","timestamp","Date","toISOString","error","details","code","validation","timeout","rateLimit","tryon","health","upload","http","post","request","body","json","modelImage","apparelImages","Array","isArray","HttpResponse","status","delay","get","formData","file","url","name","size","type","serverError","validationError","networkError","invalidJson","headers","incompleteResponse","fast","slow","variable","delays","randomDelay","Math","floor","random","length","setupServer","beforeAll","listen","onUnhandledRequest","afterEach","resetHandlers","afterAll","close","useErrorScenario","scenario","use","usePerformanceScenario","useCustomHandler","handler","createCustomTryonHandler","response","options","delayMs","shouldFail","fullResponse","getApiCalls","reset","createFileUploadHandler","originalName","completion","id","object","created","now","model","choices","text","index","logprobs","finish_reason","imageGeneration","data"],"mappings":"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"}