{"version":3,"sources":["/Users/willstreeter/WebstormProjects/vibe-coding/those-people/The-Sus-Fit-gp/src/business-layer/utils/optimisticUpdates.ts"],"sourcesContent":["// Optimistic Updates Manager\n// Handles immediate UI feedback and rollback mechanisms for try-on mutations\n\nimport { QueryClient } from '@tanstack/react-query';\nimport type {\n  TryonMutationVariables,\n  TryonMutationResponse,\n  TryonMutationContext\n} from '../types/tryon.types';\nimport type {\n  TryonHistoryEntry,\n  TryonHistoryCollection\n} from '../types/history.types';\nimport { HISTORY_QUERY_KEYS } from '../hooks/useTryonHistory';\n\n/**\n * Configuration for optimistic updates\n */\nexport interface OptimisticUpdateConfig {\n  /** Whether to show immediate preview of generated image */\n  showPreview?: boolean;\n  /** Whether to add optimistic entry to history */\n  updateHistory?: boolean;\n  /** Whether to show loading progress indicators */\n  showProgress?: boolean;\n  /** Custom preview image to show during processing */\n  previewPlaceholder?: string;\n  /** Estimated processing time for progress calculation */\n  estimatedProcessingTime?: number;\n}\n\n/**\n * Default optimistic update configuration\n */\nconst DEFAULT_OPTIMISTIC_CONFIG: Required<OptimisticUpdateConfig> = {\n  showPreview: true,\n  updateHistory: true,\n  showProgress: true,\n  previewPlaceholder: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxNTM2IiB2aWV3Qm94PSIwIDAgMTAyNCAxNTM2IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxNTM2IiBmaWxsPSIjZjNmNGY2Ii8+CjxjaXJjbGUgY3g9IjUxMiIgY3k9Ijc2OCIgcj0iNjQiIGZpbGw9IiNkMWQ1ZGIiLz4KPHN2ZyBpZD0ic3Bpbm5lciIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiB2aWV3Qm94PSIwIDAgNjQgNjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjI0IiBzdHJva2U9IiM2MzY2ZjEiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtZGFzaGFycmF5PSIxNTAuNzk2NDQ3MzcyMTAwMiIgc3Ryb2tlLWRhc2hvZmZzZXQ9IjE1MC43OTY0NDczNzIxMDAwMiI+CjxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiB2YWx1ZXM9IjAgMzIgMzI7MzYwIDMyIDMyIiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgo8L2NpcmNsZT4KPC9zdmc+', // Loading spinner SVG\n  estimatedProcessingTime: 8000 // 8 seconds\n};\n\n/**\n * Context for tracking optimistic updates\n */\nexport interface OptimisticUpdateContext {\n  /** Unique identifier for this optimistic update */\n  optimisticId: string;\n  /** Original mutation variables */\n  variables: TryonMutationVariables;\n  /** Configuration used */\n  config: OptimisticUpdateConfig;\n  /** Start time for progress calculation */\n  startTime: number;\n  /** Optimistic history entry ID if created */\n  optimisticHistoryId?: string;\n  /** Rollback functions */\n  rollbackFunctions: Array<() => void>;\n}\n\n/**\n * Optimistic updates manager class\n */\nexport class OptimisticUpdatesManager {\n  private queryClient: QueryClient;\n  private activeOptimisticUpdates = new Map<string, OptimisticUpdateContext>();\n\n  constructor(queryClient: QueryClient) {\n    this.queryClient = queryClient;\n  }\n\n  /**\n   * Start optimistic updates for a try-on mutation\n   */\n  startOptimisticUpdate(\n    variables: TryonMutationVariables,\n    config: OptimisticUpdateConfig = {}\n  ): OptimisticUpdateContext {\n    const mergedConfig = { ...DEFAULT_OPTIMISTIC_CONFIG, ...config };\n    const optimisticId = `optimistic_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    \n    const context: OptimisticUpdateContext = {\n      optimisticId,\n      variables,\n      config: mergedConfig,\n      startTime: Date.now(),\n      rollbackFunctions: []\n    };\n\n    // Apply optimistic updates\n    this.applyOptimisticUpdates(context);\n    \n    // Store context for potential rollback\n    this.activeOptimisticUpdates.set(optimisticId, context);\n\n    return context;\n  }\n\n  /**\n   * Apply optimistic updates to the cache\n   */\n  private applyOptimisticUpdates(context: OptimisticUpdateContext): void {\n    const { variables, config, optimisticId } = context;\n\n    // 1. Add optimistic history entry if enabled\n    if (config.updateHistory) {\n      this.addOptimisticHistoryEntry(context);\n    }\n\n    // 2. Set up progress indicator data if enabled\n    if (config.showProgress) {\n      this.setupProgressIndicator(context);\n    }\n\n    // 3. Pre-cache expected result structure\n    this.setupResultCaching(context);\n  }\n\n  /**\n   * Add optimistic history entry\n   */\n  private addOptimisticHistoryEntry(context: OptimisticUpdateContext): void {\n    const { variables, config, optimisticId } = context;\n    \n    const optimisticHistoryId = `optimistic_history_${optimisticId}`;\n    context.optimisticHistoryId = optimisticHistoryId;\n\n    // Create optimistic history entry\n    const optimisticEntry: TryonHistoryEntry = {\n      id: optimisticHistoryId,\n      timestamp: new Date().toISOString(),\n      generatedImage: config.previewPlaceholder || DEFAULT_OPTIMISTIC_CONFIG.previewPlaceholder,\n      modelImage: variables.modelImage,\n      apparelImages: variables.apparelImages,\n      processingTime: undefined, // Will be updated on completion\n      metadata: {\n        processingConfig: {\n          imageProcessing: variables.options?.imageProcessing,\n          requestOptions: {\n            timeout: variables.options?.timeout,\n            quality: variables.options?.quality\n          }\n        }\n      },\n      tags: ['processing', 'optimistic'],\n      notes: 'Processing...',\n      isFavorite: false\n    };\n\n    // Update history cache optimistically\n    const historyQueryKey = HISTORY_QUERY_KEYS.entries();\n    this.queryClient.setQueryData<TryonHistoryCollection>(\n      historyQueryKey,\n      (oldData) => {\n        if (!oldData) {\n          return {\n            entries: [optimisticEntry],\n            totalCount: 1,\n            currentPage: 0,\n            pageSize: 20,\n            hasMore: false,\n            lastUpdated: new Date().toISOString()\n          };\n        }\n\n        return {\n          ...oldData,\n          entries: [optimisticEntry, ...oldData.entries],\n          totalCount: oldData.totalCount + 1,\n          lastUpdated: new Date().toISOString()\n        };\n      }\n    );\n\n    // Add rollback function\n    context.rollbackFunctions.push(() => {\n      this.queryClient.setQueryData<TryonHistoryCollection>(\n        historyQueryKey,\n        (oldData) => {\n          if (!oldData) return oldData;\n          \n          return {\n            ...oldData,\n            entries: oldData.entries.filter(entry => entry.id !== optimisticHistoryId),\n            totalCount: Math.max(0, oldData.totalCount - 1),\n            lastUpdated: new Date().toISOString()\n          };\n        }\n      );\n    });\n  }\n\n  /**\n   * Set up progress indicator data\n   */\n  private setupProgressIndicator(context: OptimisticUpdateContext): void {\n    const { optimisticId, config } = context;\n    const progressQueryKey = ['tryon-progress', optimisticId];\n\n    // Initialize progress data\n    const initialProgress = {\n      id: optimisticId,\n      status: 'processing' as const,\n      progress: 0,\n      stage: 'image-processing' as const,\n      estimatedTimeRemaining: config.estimatedProcessingTime,\n      startTime: context.startTime\n    };\n\n    this.queryClient.setQueryData(progressQueryKey, initialProgress);\n\n    // Simulate progress updates\n    const progressInterval = setInterval(() => {\n      const elapsed = Date.now() - context.startTime;\n      const progress = Math.min(90, (elapsed / (config.estimatedProcessingTime || 8000)) * 100);\n      \n      let stage: string = 'image-processing';\n      if (progress > 20) stage = 'ai-generation';\n      if (progress > 60) stage = 'post-processing';\n      if (progress > 80) stage = 'finalizing';\n\n      const progressData = {\n        id: optimisticId,\n        status: 'processing' as const,\n        progress,\n        stage,\n        estimatedTimeRemaining: Math.max(0, (config.estimatedProcessingTime || 8000) - elapsed),\n        startTime: context.startTime\n      };\n\n      this.queryClient.setQueryData(progressQueryKey, progressData);\n    }, 500);\n\n    // Add rollback function to clear progress\n    context.rollbackFunctions.push(() => {\n      clearInterval(progressInterval);\n      this.queryClient.removeQueries({ queryKey: progressQueryKey });\n    });\n  }\n\n  /**\n   * Set up result caching structure\n   */\n  private setupResultCaching(context: OptimisticUpdateContext): void {\n    // Pre-populate the cache structure for the expected result\n    const resultQueryKey = ['tryon-result', context.optimisticId];\n    \n    const pendingResult = {\n      id: context.optimisticId,\n      status: 'pending' as const,\n      variables: context.variables,\n      startTime: context.startTime\n    };\n\n    this.queryClient.setQueryData(resultQueryKey, pendingResult);\n\n    // Add rollback function\n    context.rollbackFunctions.push(() => {\n      this.queryClient.removeQueries({ queryKey: resultQueryKey });\n    });\n  }\n\n  /**\n   * Complete optimistic update with actual result\n   */\n  completeOptimisticUpdate(\n    optimisticId: string,\n    result: TryonMutationResponse,\n    mutationContext: TryonMutationContext\n  ): void {\n    const context = this.activeOptimisticUpdates.get(optimisticId);\n    if (!context) return;\n\n    const processingTime = Date.now() - context.startTime;\n\n    // Update history entry if it was created optimistically\n    if (context.optimisticHistoryId) {\n      const historyQueryKey = HISTORY_QUERY_KEYS.entries();\n      this.queryClient.setQueryData<TryonHistoryCollection>(\n        historyQueryKey,\n        (oldData) => {\n          if (!oldData) return oldData;\n\n          return {\n            ...oldData,\n            entries: oldData.entries.map(entry => \n              entry.id === context.optimisticHistoryId\n                ? {\n                    ...entry,\n                    id: `completed_${Date.now()}`, // Generate new real ID\n                    generatedImage: result.img_generated,\n                    processingTime,\n                    metadata: {\n                      ...entry.metadata,\n                      modelVersion: result.metadata?.modelVersion,\n                      appliedQuality: result.metadata?.appliedQuality,\n                      imageProcessingResults: mutationContext.imageProcessingResults\n                    },\n                    tags: entry.tags?.filter(tag => tag !== 'processing' && tag !== 'optimistic') || [],\n                    notes: `Completed in ${(processingTime / 1000).toFixed(1)}s`\n                  }\n                : entry\n            ),\n            lastUpdated: new Date().toISOString()\n          };\n        }\n      );\n    }\n\n    // Update progress to completion\n    const progressQueryKey = ['tryon-progress', optimisticId];\n    this.queryClient.setQueryData(progressQueryKey, {\n      id: optimisticId,\n      status: 'completed' as const,\n      progress: 100,\n      stage: 'completed',\n      estimatedTimeRemaining: 0,\n      startTime: context.startTime,\n      completedAt: Date.now(),\n      result\n    });\n\n    // Update result cache\n    const resultQueryKey = ['tryon-result', optimisticId];\n    this.queryClient.setQueryData(resultQueryKey, {\n      id: optimisticId,\n      status: 'completed' as const,\n      variables: context.variables,\n      startTime: context.startTime,\n      completedAt: Date.now(),\n      processingTime,\n      result\n    });\n\n    // Clean up\n    this.cleanupOptimisticUpdate(optimisticId);\n  }\n\n  /**\n   * Rollback optimistic update on failure\n   */\n  rollbackOptimisticUpdate(optimisticId: string, error?: unknown): void {\n    const context = this.activeOptimisticUpdates.get(optimisticId);\n    if (!context) return;\n\n    // Execute all rollback functions\n    context.rollbackFunctions.forEach(rollback => {\n      try {\n        rollback();\n      } catch (rollbackError) {\n        console.error('Error during optimistic update rollback:', rollbackError);\n      }\n    });\n\n    // Update progress to error state\n    const progressQueryKey = ['tryon-progress', optimisticId];\n    this.queryClient.setQueryData(progressQueryKey, {\n      id: optimisticId,\n      status: 'error' as const,\n      progress: 0,\n      stage: 'error',\n      estimatedTimeRemaining: 0,\n      startTime: context.startTime,\n      error: error instanceof Error ? error.message : String(error)\n    });\n\n    // Clean up\n    this.cleanupOptimisticUpdate(optimisticId);\n  }\n\n  /**\n   * Clean up optimistic update context\n   */\n  private cleanupOptimisticUpdate(optimisticId: string): void {\n    this.activeOptimisticUpdates.delete(optimisticId);\n    \n    // Schedule cleanup of progress and result caches after a delay\n    setTimeout(() => {\n      this.queryClient.removeQueries({ \n        queryKey: ['tryon-progress', optimisticId] \n      });\n      this.queryClient.removeQueries({ \n        queryKey: ['tryon-result', optimisticId] \n      });\n    }, 5000); // Keep for 5 seconds for UI transitions\n  }\n\n  /**\n   * Get current progress for an optimistic update\n   */\n  getOptimisticProgress(optimisticId: string) {\n    const progressQueryKey = ['tryon-progress', optimisticId];\n    return this.queryClient.getQueryData(progressQueryKey);\n  }\n\n  /**\n   * Check if an optimistic update is active\n   */\n  isOptimisticUpdateActive(optimisticId: string): boolean {\n    return this.activeOptimisticUpdates.has(optimisticId);\n  }\n\n  /**\n   * Get all active optimistic updates\n   */\n  getActiveOptimisticUpdates(): OptimisticUpdateContext[] {\n    return Array.from(this.activeOptimisticUpdates.values());\n  }\n}\n\n/**\n * Default optimistic updates manager instance\n */\nexport let defaultOptimisticManager: OptimisticUpdatesManager | null = null;\n\n/**\n * Initialize the default optimistic updates manager\n */\nexport function initializeOptimisticUpdates(queryClient: QueryClient): OptimisticUpdatesManager {\n  defaultOptimisticManager = new OptimisticUpdatesManager(queryClient);\n  return defaultOptimisticManager;\n}\n\n/**\n * Get the default optimistic updates manager\n */\nexport function getOptimisticUpdatesManager(): OptimisticUpdatesManager {\n  if (!defaultOptimisticManager) {\n    throw new Error('OptimisticUpdatesManager not initialized. Call initializeOptimisticUpdates first.');\n  }\n  return defaultOptimisticManager;\n}"],"names":["OptimisticUpdatesManager","defaultOptimisticManager","getOptimisticUpdatesManager","initializeOptimisticUpdates","DEFAULT_OPTIMISTIC_CONFIG","showPreview","updateHistory","showProgress","previewPlaceholder","estimatedProcessingTime","constructor","queryClient","activeOptimisticUpdates","Map","startOptimisticUpdate","variables","config","mergedConfig","optimisticId","Date","now","Math","random","toString","substr","context","startTime","rollbackFunctions","applyOptimisticUpdates","set","addOptimisticHistoryEntry","setupProgressIndicator","setupResultCaching","optimisticHistoryId","optimisticEntry","id","timestamp","toISOString","generatedImage","modelImage","apparelImages","processingTime","undefined","metadata","processingConfig","imageProcessing","options","requestOptions","timeout","quality","tags","notes","isFavorite","historyQueryKey","HISTORY_QUERY_KEYS","entries","setQueryData","oldData","totalCount","currentPage","pageSize","hasMore","lastUpdated","push","filter","entry","max","progressQueryKey","initialProgress","status","progress","stage","estimatedTimeRemaining","progressInterval","setInterval","elapsed","min","progressData","clearInterval","removeQueries","queryKey","resultQueryKey","pendingResult","completeOptimisticUpdate","result","mutationContext","get","map","img_generated","modelVersion","appliedQuality","imageProcessingResults","tag","toFixed","completedAt","cleanupOptimisticUpdate","rollbackOptimisticUpdate","error","forEach","rollback","rollbackError","console","Error","message","String","delete","setTimeout","getOptimisticProgress","getQueryData","isOptimisticUpdateActive","has","getActiveOptimisticUpdates","Array","from","values"],"mappings":"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"}