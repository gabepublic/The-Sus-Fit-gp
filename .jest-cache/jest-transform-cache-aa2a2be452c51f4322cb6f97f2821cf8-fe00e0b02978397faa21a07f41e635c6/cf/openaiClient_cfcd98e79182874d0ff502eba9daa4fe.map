{"version":3,"sources":["/Users/willstreeter/WebstormProjects/vibe-coding/those-people/The-Sus-Fit-gp/src/lib/openaiClient.ts"],"sourcesContent":["/**\n * OpenAI Client Initialization and Try-On Service\n * \n * Provides a singleton OpenAI client instance with secure environment variable retrieval\n * and implements the core try-on functionality using OpenAI Images Edit API.\n * This module handles the foundational SDK initialization and service wrapper logic.\n */\n\nimport OpenAI from 'openai';\nimport { getEnv } from './getEnv';\nimport { TryOnParamsSchema, TryOnResultSchema, type TryOnParams, normalizeBase64 } from './tryOnSchema';\nimport * as fs from 'fs';\n\n// Retrieve and validate environment variables with fail-fast approach\nconst { key, model } = getEnv();\n\n// Instantiate singleton OpenAI client\nconst openai = new OpenAI({ apiKey: key });\n\n// Export both the client instance and model for reuse by other modules\nexport { openai, model };\n\n/**\n * Convert base64 string to File object for OpenAI API\n * \n * @param base64String - Base64 encoded image string (with or without data URL prefix)\n * @param filename - Name for the file (default: 'image.png')\n * @returns File object suitable for OpenAI API\n */\nconst base64ToFile = (base64String: string, filename: string = 'image.png'): File => {\n  // Normalize base64 (strip data URL prefix if present)\n  const normalizedBase64 = normalizeBase64(base64String);\n  \n  // Convert base64 to binary data using Node.js Buffer\n  const buffer = Buffer.from(normalizedBase64, 'base64');\n\n  // KEEP for TESTING; DO NOT REMOVE\n  // Save file to local drive\n  //const fs = require('fs');\n  //const path = require('path');\n  //const savePath = path.join(process.cwd(), 'uploads', filename);\n  //fs.mkdirSync(path.dirname(savePath), { recursive: true });\n  //fs.writeFileSync(savePath, buffer);\n  \n  // Create blob and file\n  const blob = new Blob([buffer], { type: 'image/png' });\n  return new File([blob], filename, { type: 'image/png' });\n};\n\n/**\n * Generate a try-on image by combining a model image with apparel images\n * \n * This function uses OpenAI's Images Edit API to create a virtual try-on effect,\n * where the model's garment is replaced with the provided apparel image.\n * \n * @param params - Object containing modelImage (base64) and apparelImages array (base64)\n * @returns Promise<string> - Base64 encoded generated image\n * @throws Error - When validation fails, API call fails, or response is invalid\n * \n * @example\n * ```typescript\n * const result = await generateTryOn({\n *   modelImage: \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\",\n *   apparelImages: [\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\"]\n * });\n * // Returns: \"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\"\n * ```\n */\nexport const generateTryOn = async ({ modelImage, apparelImages }: TryOnParams): Promise<string> => {\n  try {\n    // Validate input parameters\n    TryOnParamsSchema.parse({ modelImage, apparelImages });\n\n    // Convert base64 strings to File objects for OpenAI API\n    const modelFile = base64ToFile(modelImage, 'model.png');\n    const apparelFile = base64ToFile(apparelImages[0], 'apparel.png');\n\n    if (model == 'mock') {\n      console.log('Using mock model');\n      // Validate output using schema\n      const validatedResult = TryOnResultSchema.parse({ imgGenerated: fs.readFileSync('public/images/demo/WillShalom.jpg', { encoding: 'base64' }) });\n      return validatedResult.imgGenerated;\n    }\n\n    // Call OpenAI Images Edit API\n    const response = await openai.images.edit({\n      model,\n      image: [modelFile, apparelFile],\n      prompt: 'Change the garment of the model in the first image with the garment from the second image.',\n      n: 1,\n      size: '1024x1024',\n      quality: 'low'\n    });\n\n    // Extract and validate the generated image\n    if (!response.data || response.data.length === 0) {\n      throw new Error('No response data received from OpenAI API');\n    }\n    \n    const b64Json = response.data[0]?.b64_json;\n    if (!b64Json) {\n      throw new Error('No image data received from OpenAI API');\n    }\n    console.log('Generated image length: ', b64Json.length);\n    \n    // KEEP for TESTING; DO NOT REMOVE\n    // Save generated image to file\n    //const generatedImageFile = base64ToFile(b64Json, 'generated.png');\n\n    // Validate output using schema\n    const validatedResult = TryOnResultSchema.parse({ imgGenerated: b64Json });\n\n    return validatedResult.imgGenerated;\n  } catch (error) {\n    // Re-throw with custom context while preserving original error\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\n    const customError = new Error(`generateTryOn failed: ${errorMessage}`);\n    (customError as Error & { cause?: unknown }).cause = error; // Set cause property for error chaining\n    throw customError;\n  }\n}; "],"names":["generateTryOn","model","openai","key","getEnv","OpenAI","apiKey","base64ToFile","base64String","filename","normalizedBase64","normalizeBase64","buffer","Buffer","from","blob","Blob","type","File","modelImage","apparelImages","TryOnParamsSchema","parse","modelFile","apparelFile","console","log","validatedResult","TryOnResultSchema","imgGenerated","fs","readFileSync","encoding","response","images","edit","image","prompt","n","size","quality","data","length","Error","b64Json","b64_json","error","errorMessage","message","customError","cause"],"mappings":"AAAA;;;;;;CAMC;;;;;;;;;;;IA8DYA,aAAa;eAAbA;;IAhDIC,KAAK;eAALA;;IAARC,MAAM;eAANA;;;+DAZU;wBACI;6BACiE;4DACpE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEpB,sEAAsE;AACtE,MAAM,EAAEC,GAAG,EAAEF,KAAK,EAAE,GAAGG,IAAAA,cAAM;AAE7B,sCAAsC;AACtC,MAAMF,SAAS,IAAIG,eAAM,CAAC;IAAEC,QAAQH;AAAI;AAKxC;;;;;;CAMC,GACD,MAAMI,eAAe,CAACC,cAAsBC,WAAmB,WAAW;IACxE,sDAAsD;IACtD,MAAMC,mBAAmBC,IAAAA,4BAAe,EAACH;IAEzC,qDAAqD;IACrD,MAAMI,SAASC,OAAOC,IAAI,CAACJ,kBAAkB;IAE7C,kCAAkC;IAClC,2BAA2B;IAC3B,2BAA2B;IAC3B,+BAA+B;IAC/B,iEAAiE;IACjE,4DAA4D;IAC5D,qCAAqC;IAErC,uBAAuB;IACvB,MAAMK,OAAO,IAAIC,KAAK;QAACJ;KAAO,EAAE;QAAEK,MAAM;IAAY;IACpD,OAAO,IAAIC,KAAK;QAACH;KAAK,EAAEN,UAAU;QAAEQ,MAAM;IAAY;AACxD;AAqBO,MAAMjB,gBAAgB,OAAO,EAAEmB,UAAU,EAAEC,aAAa,EAAe;IAC5E,IAAI;QACF,4BAA4B;QAC5BC,8BAAiB,CAACC,KAAK,CAAC;YAAEH;YAAYC;QAAc;QAEpD,wDAAwD;QACxD,MAAMG,YAAYhB,aAAaY,YAAY;QAC3C,MAAMK,cAAcjB,aAAaa,aAAa,CAAC,EAAE,EAAE;QAEnD,IAAInB,SAAS,QAAQ;YACnBwB,QAAQC,GAAG,CAAC;YACZ,+BAA+B;YAC/B,MAAMC,kBAAkBC,8BAAiB,CAACN,KAAK,CAAC;gBAAEO,cAAcC,IAAGC,YAAY,CAAC,qCAAqC;oBAAEC,UAAU;gBAAS;YAAG;YAC7I,OAAOL,gBAAgBE,YAAY;QACrC;QAEA,8BAA8B;QAC9B,MAAMI,WAAW,MAAM/B,OAAOgC,MAAM,CAACC,IAAI,CAAC;YACxClC;YACAmC,OAAO;gBAACb;gBAAWC;aAAY;YAC/Ba,QAAQ;YACRC,GAAG;YACHC,MAAM;YACNC,SAAS;QACX;QAEA,2CAA2C;QAC3C,IAAI,CAACP,SAASQ,IAAI,IAAIR,SAASQ,IAAI,CAACC,MAAM,KAAK,GAAG;YAChD,MAAM,IAAIC,MAAM;QAClB;QAEA,MAAMC,UAAUX,SAASQ,IAAI,CAAC,EAAE,EAAEI;QAClC,IAAI,CAACD,SAAS;YACZ,MAAM,IAAID,MAAM;QAClB;QACAlB,QAAQC,GAAG,CAAC,4BAA4BkB,QAAQF,MAAM;QAEtD,kCAAkC;QAClC,+BAA+B;QAC/B,oEAAoE;QAEpE,+BAA+B;QAC/B,MAAMf,kBAAkBC,8BAAiB,CAACN,KAAK,CAAC;YAAEO,cAAce;QAAQ;QAExE,OAAOjB,gBAAgBE,YAAY;IACrC,EAAE,OAAOiB,OAAO;QACd,+DAA+D;QAC/D,MAAMC,eAAeD,iBAAiBH,QAAQG,MAAME,OAAO,GAAG;QAC9D,MAAMC,cAAc,IAAIN,MAAM,CAAC,sBAAsB,EAAEI,cAAc;QACpEE,YAA4CC,KAAK,GAAGJ,OAAO,wCAAwC;QACpG,MAAMG;IACR;AACF"}